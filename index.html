<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä»™é€”æ”¾ç½® Demo</title>
  <style>
/* ====== é€šç”¨å¸ƒå±€ & èƒŒæ™¯ ====== */
body {
  font-family: "Microsoft YaHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, #1b2340, #05060a);
  color: #f3f3f3;
  display: flex;
  justify-content: center;
  padding: 24px 12px;
}

.app-container {
  width: 100%;
  max-width: 520px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ====== é¡¶éƒ¨æ ‡é¢˜æ  ====== */
.top-bar {
  text-align: center;
  margin-bottom: 8px;
}

h1 {
  margin-bottom: 4px;
  letter-spacing: 2px;
  font-size: 24px;
}

.subtitle {
  font-size: 13px;
  color: #b6c1ff;
  margin-bottom: 4px;
}

.player-info {
  font-size: 13px;
  color: #d3d6ff;
}

/* ====== ä¸»ä½“åŒºåŸŸ ====== */
.main-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
}

/* çŠ¶æ€é¢æ¿ */
.stats {
  margin: 10px 0 10px;
  text-align: center;
  line-height: 1.6;
  padding: 12px 18px;
  border-radius: 12px;
  background: rgba(15, 20, 40, 0.9);
  box-shadow: 0 0 18px rgba(0, 0, 0, 0.45);
  border: 1px solid rgba(120, 150, 255, 0.4);
  width: 100%;
}

#realm {
  font-weight: bold;
  color: #ffd56b;
}

.stats-actions {
  margin-top: 6px;
  display: flex;
  justify-content: center;
  gap: 8px;
}

/* æŒ‰é’®æ ·å¼ */
button {
  padding: 10px 16px;
  margin: 6px 0;
  border: none;
  border-radius: 999px;
  cursor: pointer;
  font-size: 14px;
  background: linear-gradient(120deg, #3a8bff, #7a5cff);
  color: #fff;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.45);
  transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.2s ease;
}

button:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
}

button:active:not(:disabled) {
  transform: translateY(1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-main {
  font-size: 18px;
  padding: 12px 24px;
  margin: 12px 0 10px;
}

.btn-small {
  padding: 6px 10px;
  font-size: 12px;
  margin: 0;
}

/* é€šç”¨åŠŸèƒ½é¢æ¿å¡ç‰‡ */
.panel {
  background: rgba(12, 16, 32, 0.95);
  border-radius: 14px;
  padding: 16px;
  margin-top: 8px;
  width: 100%;
  box-shadow: 0 0 14px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(90, 120, 220, 0.7);
}

.panel h2 {
  margin-top: 0;
  font-size: 18px;
  color: #e9f0ff;
  display: flex;
  align-items: center;
  gap: 6px;
}

.panel h2::before {
  content: "âœ¦";
  font-size: 14px;
  color: #ffd56b;
}

.upgrade {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 6px 0;
}

.upgrade-info {
  font-size: 13px;
}

.hint {
  font-size: 12px;
  color: #9aa0c6;
  margin-top: 8px;
  line-height: 1.5;
}

/* å…­ç»´è¡¨æ ¼ */
.stats-grid {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 13px;
}

.stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.stat-right {
  display: flex;
  align-items: center;
  gap: 4px;
}

.btn-plus {
  padding: 2px 8px;
  font-size: 11px;
  margin: 0;
  border-radius: 999px;
  background: linear-gradient(120deg, #5ac8fa, #007aff);
}

/* çµæ ¹è¯´æ˜è¡¨ */
.ling-root-table {
  font-size: 13px;
  margin-top: 8px;
}

.ling-root-row {
  display: flex;
  justify-content: space-between;
  margin: 2px 0;
}

/* æ¸¸å†æ—¥å¿— */
#battleLog {
  margin-top: 8px;
  max-height: 220px;
  overflow-y: auto;
  font-size: 12px;
  line-height: 1.5;
  background: rgba(5, 8, 20, 0.85);
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid rgba(120, 150, 255, 0.3);
}

/* åº•éƒ¨å¯¼èˆª */
.bottom-nav {
  margin-top: 16px;
  padding: 8px 10px;
  border-radius: 18px;
  background: rgba(10, 12, 24, 0.95);
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 11px;
  color: #9aa0c6;
}

.nav-item.active {
  color: #ffd56b;
}

.nav-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: radial-gradient(circle, #384173, #151728);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin-bottom: 4px;
}

/* å¼€å±€è¾“å…¥é“å·ç•Œé¢ */
.start-screen {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.82);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
}

.start-card {
  background: rgba(10, 12, 30, 0.98);
  border-radius: 16px;
  padding: 20px 18px;
  width: 90%;
  max-width: 360px;
  box-shadow: 0 0 24px rgba(0, 0, 0, 0.8);
  border: 1px solid rgba(120, 150, 255, 0.8);
  text-align: center;
}

.start-card h2 {
  margin-top: 0;
  margin-bottom: 10px;
  font-size: 20px;
}

.start-card p {
  font-size: 13px;
  color: #c0c6ff;
  margin-bottom: 10px;
}

.start-card input {
  width: 80%;
  padding: 8px 12px;
  border-radius: 999px;
  border: none;
  outline: none;
  margin: 8px 0 14px;
  font-size: 14px;
}

.start-card .tip {
  font-size: 12px;
  color: #8f94c9;
  margin-bottom: 10px;
}

/* æ¸¸å†ç»“ç®— & éšæœºäº‹ä»¶å¼¹å±‚ */
.overlay-screen {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.78);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 110;
}

.result-card {
  background: rgba(10, 12, 30, 0.98);
  border-radius: 16px;
  padding: 18px 16px;
  width: 90%;
  max-width: 360px;
  box-shadow: 0 0 24px rgba(0, 0, 0, 0.8);
  border: 1px solid rgba(200, 180, 120, 0.8);
  text-align: left;
}

.result-card h2 {
  margin: 0 0 8px;
  font-size: 18px;
}

.result-summary {
  font-size: 13px;
  color: #f5f5f5;
  margin-bottom: 8px;
}

.result-drops {
  font-size: 13px;
  color: #ffd56b;
  margin-bottom: 8px;
}

.result-extra {
  font-size: 12px;
  color: #d6dcff;
  margin-bottom: 8px;
}

.result-random {
  font-size: 12px;
  color: #c0c6ff;
  margin-bottom: 10px;
}

/* ====== åŠŸæ³• / å®—é—¨ / æŠ€èƒ½å±•ç¤º ====== */
.skill-item {
  border-radius: 8px;
  padding: 6px 8px;
  margin-bottom: 6px;
  background: rgba(20, 24, 48, 0.9);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 8px;
  font-size: 12px;
}

.skill-left {
  flex: 1;
}

.skill-name {
  font-size: 13px;
  font-weight: bold;
  margin-bottom: 2px;
}

/* ç¨€æœ‰åº¦é¢œè‰²ï¼šå‡¡å“ã€ç½•è§ã€ç¨€æœ‰ã€çå“ã€ç»å“ã€ä»™æ³• */
.skill-rarity-common { color: #f5f5f5; }
.skill-rarity-uncommon { color: #6cff8f; }
.skill-rarity-rare { color: #4ea1ff; }
.skill-rarity-epic { color: #c47dff; }
.skill-rarity-legendary { color: #ffd86b; }
.skill-rarity-mythic { color: #ff6666; }

/* å¤§å±å¹•ï¼ˆå¯é€‰ï¼‰ */
@media (min-width: 900px) {
  .app-container {
    max-width: 620px;
  }
}
  
/* ====== å¼€å±€çµæ ¹æŠ½å–è½¬ç›˜ & é«˜å…‰é¢œè‰² ====== */

.root-draw-panel {
  margin: 32px auto 12px;
  max-width: 420px;
}

.root-draw-subtitle {
  font-size: 13px;
  color: #c0c6ff;
  margin-bottom: 4px;
}

.root-wheel-wrapper {
  display: flex;
  justify-content: center;
  margin: 10px 0;
}

.root-wheel {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 0 12px rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-size: 13px;
}

.root-wheel-name {
  padding: 4px 6px;
}

.root-result {
  font-size: 13px;
  margin-top: 6px;
}

.root-result-tier {
  margin-top: 2px;
}

.root-result-desc {
  margin-top: 4px;
  color: #c0c6ff;
}

.root-draw-controls {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.root-draw-controls button {
  flex: 1;
}

.root-confirm-row {
  margin-top: 10px;
  text-align: center;
}

.root-warning {
  margin-top: 8px;
  font-size: 12px;
  color: #ffdd9b;
}

.spirit-root-tag {
  display: inline-flex;
  align-items: center;
  padding: 1px 8px;
  border-radius: 999px;
  background: rgba(10, 16, 40, 0.9);
  font-weight: 600;
  font-size: 13px;
}

/* çµæ ¹é«˜å…‰é¢œè‰²ï¼ˆä»…ç”¨äºæ–‡å­—ï¼‰ */
.root-color-metal   { color: #ffd94a; text-shadow: 0 0 6px rgba(255, 217, 74, 0.8); }
.root-color-wood    { color: #4cd964; text-shadow: 0 0 6px rgba(76, 217, 100, 0.8); }
.root-color-water   { color: #5ac8fa; text-shadow: 0 0 6px rgba(90, 200, 250, 0.8); }
.root-color-fire    { color: #ff3b30; text-shadow: 0 0 6px rgba(255, 59, 48, 0.8); }
.root-color-earth   { color: #d08b4c; text-shadow: 0 0 6px rgba(208, 139, 76, 0.8); }

.root-color-ice     { color: #a0e9ff; text-shadow: 0 0 6px rgba(160, 233, 255, 0.8); }
.root-color-thunder { color: #b076ff; text-shadow: 0 0 6px rgba(176, 118, 255, 0.8); }
.root-color-heart   { color: #ff8ac9; text-shadow: 0 0 6px rgba(255, 138, 201, 0.8); }
.root-color-spirit  { color: #c6ffb5; text-shadow: 0 0 6px rgba(198, 255, 181, 0.8); }
.root-color-dream   { color: #ffd1f2; text-shadow: 0 0 6px rgba(255, 209, 242, 0.8); }

.root-color-dark    { color: #b00020; text-shadow: 0 0 6px rgba(176, 0, 32, 0.8); }
.root-color-light   { color: #fff5d9; text-shadow: 0 0 6px rgba(255, 245, 217, 0.9); }
.root-color-realm   { color: #c4e0ff; text-shadow: 0 0 6px rgba(196, 224, 255, 0.9); }
.root-color-holy    { color: #f3e2b5; text-shadow: 0 0 6px rgba(243, 226, 181, 0.9); }

/* ç©ºé—´ / æ—¶é—´ï¼šä¸€åŠé»‘ä¸€åŠç™½çš„æ–‡å­— */
.root-color-space {
  background-image: linear-gradient(90deg, #000 0%, #000 50%, #fff 50%, #fff 100%);
  -webkit-background-clip: text;
  color: transparent;
}

.root-color-time {
  background-image: linear-gradient(90deg, #fff 0%, #fff 50%, #000 50%, #000 100%);
  -webkit-background-clip: text;
  color: transparent;
}

/* å› æœï¼šé»‘ç™½é—ªçƒ */
.root-color-cause {
  animation: root-cause-blink 1.2s infinite;
}

@keyframes root-cause-blink {
  0%, 45% {
    color: #000;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
  }
  55%, 100% {
    color: #fff;
    text-shadow: 0 0 5px rgba(255, 255, 255, 0.9);
  }
}

/* ===== è‡ªå®šä¹‰åº•éƒ¨ä¸»èœå•å›¾ç‰‡æ¡ ===== */
.app-container {
  padding-bottom: 130px;
}

.bottom-nav {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 16px;
  width: 100%;
  max-width: 520px;
  height: 96px;
  margin-top: 0;
  padding: 0;
  border-radius: 0;
  background: url('main_menu_bar_cropped.png') no-repeat center center;
  background-size: 100% 100%;
  background-position: center bottom;
  box-shadow: none;
}

.bottom-nav .nav-item {
  flex: 1;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  padding-bottom: 12px;
  background: transparent;
}

.bottom-nav .nav-icon,
.bottom-nav .nav-label {
  font-size: 0;
  line-height: 0;
}

.bottom-nav .nav-icon {
  display: none;
}

.bottom-nav .nav-label {
  display: none;
}
  </style>
</head>
<body>

  <!-- å¼€å±€å‘½å -->
  <div id="startScreen" class="start-screen">
    <div class="start-card">
      <h2>è¸å…¥ä¿®ä»™ä¹‹è·¯</h2>
      <p>è¯·ä¸ºè‡ªå·±å–ä¸€ä¸ªé“å·ï¼š</p>
      <input id="playerNameInput" type="text" placeholder="ä¾‹å¦‚ï¼šæ— åæ•£ä¿® / é’å±±æ•£äºº" />
      <div class="tip">å¼€å§‹ä¿®ç‚¼åï¼Œå°†éšæœºè§‰é†’ä¸€ç»„çµæ ¹ï¼ˆå¯èƒ½ä¸ºç¨€æœ‰å•çµæ ¹æˆ–åŒäº”è¡Œçµæ ¹ï¼‰ã€‚</div>
      <button id="startGameBtn">å¼€å§‹ä¿®ç‚¼</button>
    </div>
  </div>

  <!-- çµæ ¹æŠ½å–é¢æ¿ï¼šèµ·åä¹‹åå‡ºç° -->
  <div id="rootDrawPanel" class="panel root-draw-panel" style="display:none;">
    <h2>æŠ½å–ä½ çš„çµæ ¹</h2>
    <div class="root-draw-subtitle">
      é“å·ï¼š<span id="rootPlayerName">æ— åæ•£ä¿®</span>
    </div>

    <!-- ç®€å•è½¬ç›˜åŒºåŸŸ -->
    <div class="root-wheel-wrapper">
      <div class="root-wheel" id="rootWheel">
        <div class="root-wheel-name" id="rootWheelName">ç‚¹å‡»å¼€å§‹è½¬ç›˜</div>
      </div>
    </div>

    <!-- å½“å‰æŠ½åˆ°çš„çµæ ¹ä¿¡æ¯ -->
    <div class="root-result">
      <div>
        å½“å‰çµæ ¹ï¼š
        <span id="rootResultName" class="spirit-root-tag">æœªæŠ½å–</span>
      </div>
      <div class="root-result-tier">
        å“é˜¶ï¼š<span id="rootResultTier">-</span>
      </div>
      <div class="root-result-desc" id="rootResultDesc">è¯·å…ˆç‚¹å‡»ã€Œå¼€å§‹æŠ½å–ã€ã€‚</div>
    </div>

    <div class="root-draw-controls">
      <button id="btnRootRoll">å¼€å§‹æŠ½å–</button>
      <button id="btnRootReroll" disabled>åˆ·æ–°çµæ ¹ï¼ˆå‰©ä½™ <span id="rootRerollLeft">2</span> æ¬¡ï¼‰</button>
    </div>

    <div class="root-confirm-row">
      <button id="btnRootConfirm" class="btn-main" disabled>ç¡®è®¤æ­¤çµæ ¹å¹¶å¼€å§‹ä¿®è¡Œ</button>
    </div>

    <div class="hint root-warning">
      â€» çµæ ¹ä¸€æ—¦ç¡®è®¤å°†<span class="text-highlight">æ— æ³•æ›´æ”¹</span>ï¼Œè¯·è°¨æ…é€‰æ‹©ã€‚<br>
      ç¨€æœ‰çµæ ¹æ¦‚ç‡æä½ï¼Œè‹¥å¯¹å½“å‰ç»“æœä¸æ»¡æ„ï¼Œå¯ä½¿ç”¨åˆ·æ–°æœºä¼šé‡æ–°æŠ½å–ã€‚
    </div>
  </div>

  <!-- æ¸¸å†ç»“ç®— / éšæœºäº‹ä»¶ -->
  <div id="battleResultOverlay" class="overlay-screen">
    <div class="result-card">
      <h2 id="resultTitle">æ¸¸å†ç»“æœ</h2>
      <div id="resultSummary" class="result-summary"></div>
      <div id="resultDrops" class="result-drops"></div>
      <div id="resultExtra" class="result-extra"></div>
      <div id="randomEvent" class="result-random"></div>
      <button id="closeResultBtn">è¿”å›</button>
    </div>
  </div>

  <div class="app-container" id="appContainer">
    <!-- é¡¶éƒ¨ -->
    <div class="top-bar">
      <h1>ä»™é€”æ”¾ç½® Â· Demo</h1>
      <div class="subtitle">ä»å‡¡äººå¼€å§‹ï¼Œæ¯ç§’å¸æ”¶ 0.1 ç‚¹çœŸæ°”ï¼Œè¸ä¸Šä¿®ä»™ä¹‹è·¯</div>
      <div class="player-info">
        é“å·ï¼š<span id="playerName">æœªå‘½å</span> Â· çµæ ¹ï¼š<span id="lingRootName">æœªè§‰é†’</span>
      </div>
    </div>

    <!-- ä¸»åŒºåŸŸï¼šå¤šé¡µé¢ -->
    <div class="main-area">
      <!-- ä¿®ç‚¼é¡µ -->
      <div id="pageCultivation" style="width:100%;">
        <div class="stats">
          <div>å½“å‰çœŸæ°”ï¼š<span id="qi">0.0</span></div>
          <div>æ¯ç§’ä¿®ä¸ºå¢é•¿ï¼š<span id="qps">0.0</span> / ç§’</div>
          <div>æ¯æ¬¡æ‰“åè·å¾—ï¼š<span id="qpc">1.0</span> çœŸæ°”</div>
          <div>å½“å‰å¢ƒç•Œï¼š<span id="realm">å‡¡äºº</span></div>
          <div>
            å†ç»ƒå€¼ï¼š<span id="expMainSpan">0</span>
            ï¼ˆçªç ´éœ€æ±‚ï¼š<span id="expReqSpan">â€”</span>ï¼‰
          </div>
          <div class="hint">
            å¢ƒç•Œï¼šå‡¡äºº â†’ è¾Ÿè°· â†’ ç‚¼ä½“ â†’ ç»ƒæ°” â†’ ç­‘åŸº â†’ é‡‘ä¸¹ â†’ å…ƒå©´ â†’ å‡ºçª â†’ å¤§ä¹˜ â†’ æ¸¡åŠ« â†’ åŒ–ç¥ â†’ ä»™ç­ã€‚<br>
            æ¯ä¸ªã€Œå¤§åœ†æ»¡ã€çªç ´åˆ°ä¸‹ä¸€å¤§å¢ƒç•Œï¼Œéœ€è¦è¶³å¤Ÿçš„å†ç»ƒå€¼å¹¶æ‰‹åŠ¨çªç ´ã€‚
          </div>
          <div class="stats-actions">
            <button id="breakthroughBtn" class="btn-small">çªç ´å¢ƒç•Œ</button>
            <button id="saveBtn" class="btn-small">æ‰‹åŠ¨ä¿å­˜</button>
            <button id="resetBtn" class="btn-small">æ¸…ç©ºé‡ä¿®</button>
          </div>
        </div>

        <button id="cultivateBtn" class="btn-main">æ‰“ååçº³ï¼ˆè·å¾—çœŸæ°”ï¼‰</button>

        <div class="panel">
          <h2>ä¿®ä¸ºä¸å±æ€§</h2>
          <div class="hint">
            æ¯æ¬¡è·å¾—çœŸæ°”ï¼Œæœ‰ä¸€å®šæ¦‚ç‡è·å¾—ã€Œèƒ½åŠ›ç‚¹ã€ï¼Œå¯ç”¨äºè‡ªç”±åŠ ç‚¹ï¼ˆæ¦‚ç‡è¾ƒä½ï¼Œä¸»è¦é å¢ƒç•Œè‡ªåŠ¨æˆé•¿ï¼‰ã€‚<br>
            å¯åˆ†é…èƒ½åŠ›ç‚¹ï¼š<span id="abilityPoints">0</span>
          </div>
          <div class="hint">
            å†ç»ƒå€¼ï¼ˆæ¸¸å†ç»éªŒï¼‰ï¼š<span id="experienceSpan">0</span>
            ï¼ˆå½“å‰é¢å¤–ä¼¤å®³åŠ æˆï¼š<span id="experienceBuffSpan">0</span>%ï¼‰
          </div>
          <div class="hint">
            å½“å‰çµçŸ³å‚¨é‡ï¼š<span id="spiritStonesSpan">0</span>
          </div>
          <div class="stats-grid">
            <div class="stat-row">
              <span>åŠ›é‡ï¼ˆæ”»å‡»ä¼¤å®³ï¼‰</span>
              <span class="stat-right">
                <span id="statPower">0</span>
                <button class="btn-plus" data-stat="power">+</button>
              </span>
            </div>
            <div class="stat-row">
              <span>ä½“è´¨ï¼ˆç”Ÿå‘½ã€é˜²å¾¡ï¼‰</span>
              <span class="stat-right">
                <span id="statPhysique">0</span>
                <button class="btn-plus" data-stat="physique">+</button>
              </span>
            </div>
            <div class="stat-row">
              <span>èº«æ³•ï¼ˆé—ªé¿ã€é€Ÿåº¦ï¼‰</span>
              <span class="stat-right">
                <span id="statAgility">0</span>
                <button class="btn-plus" data-stat="agility">+</button>
              </span>
            </div>
            <div class="stat-row">
              <span>ç¥è¯†ï¼ˆè“é‡ã€ç²¾ç¥ï¼‰</span>
              <span class="stat-right">
                <span id="statSpirit">0</span>
                <button class="btn-plus" data-stat="spirit">+</button>
              </span>
            </div>
            <div class="stat-row">
              <span>æ ¹éª¨ï¼ˆä½“é­„ã€éŸ§æ€§ï¼‰</span>
              <span class="stat-right">
                <span id="statRoot">0</span>
                <button class="btn-plus" data-stat="root">+</button>
              </span>
            </div>
            <div class="stat-row">
              <span>æ°”è¿ï¼ˆæœºç¼˜ã€æ‰è½ï¼‰</span>
              <span class="stat-right">
                <span id="statLuck">0</span>
                <button class="btn-plus" data-stat="luck">+</button>
              </span>
            </div>
          </div>
        </div>

        <div class="panel">
          <h2>çµæ ¹å¤©èµ‹</h2>
          <div class="hint">
            çµæ ¹ä¸ç›´æ¥æ”¹å˜æˆ˜æ–—æ•°å€¼ï¼Œä½†ä¼šæå¤§å½±å“ä¿®ç‚¼é€Ÿåº¦ã€èƒ½åŠ›ç‚¹æ‰è½ä¸å¥‡é‡è§¦å‘ã€‚<br>
            ä¿®ç‚¼å¿ƒæ³•åï¼Œå¯è¿›ä¸€æ­¥æ”¾å¤§çµæ ¹æ•ˆæœã€‚
            <br>å½“å‰çµæ ¹ç³»ç»ŸåŠ æˆï¼š<span id="lingRootBonusText">ä¿®ç‚¼é€Ÿåº¦ +0% Â· èƒ½åŠ›ç‚¹ +0% Â· å¥‡é‡æƒé‡ +0%</span>
          </div>
          <div id="lingRootTable" class="ling-root-table"></div>
        </div>

        <!-- å¤šå­˜æ¡£ç®¡ç†é¢æ¿ -->
        <div class="panel">
          <h2>å­˜æ¡£ç®¡ç†</h2>
          <div class="hint">
            å½“å‰å­˜æ¡£æ§½ï¼š<span id="activeSlotSpan">1å·</span>ï¼ˆè‡ªåŠ¨ä¿å­˜ä¼šå†™å…¥è¯¥æ§½ä½ï¼‰
          </div>
          <div id="saveSlotList" class="hint" style="margin-top:8px;"></div>
        </div>
      </div>

      <!-- æ¸¸å†é¡µ -->
      <div id="pageBattle" style="width:100%; display:none;">
        <div class="panel">
          <h2>æ¸¸å† Â· è¯•ç‚¼</h2>
          <div id="playerBattleStats" class="hint">å°šæœªè¸å…¥ä¿®è¡Œï¼Œå±æ€§æœªçŸ¥ã€‚</div>
          <div class="hint">
            æ¸¸å†ç›®çš„åœ°ï¼š
            <select id="mapSelect"></select>
          </div>
          <div class="hint">
            ä¸åŒåœ°ç‚¹æ•Œäººå¢ƒç•Œä¸åŒï¼Œè·å¾—çš„çœŸæ°” / å†ç»ƒ / çµçŸ³å¥–åŠ±ä¹Ÿä¸åŒã€‚æ•Œäººè¶Šæ¥è¿‘ä½ å½“å‰å¢ƒç•Œï¼Œå¥–åŠ±è¶Šé«˜ã€‚
          </div>
          <div class="hint">
            <label>
              <input type="checkbox" id="autoBattleToggle">
              è‡ªåŠ¨æˆ˜æ–—ç»“ç®—ï¼ˆå‹¾é€‰åæŒç»­æ¸¸å†ï¼Œä¸å†å¼¹å‡ºç»“ç®—çª—å£ï¼‰
            </label>
          </div>
          <button id="startBattleBtn" class="btn-main">å¼€å§‹æ¸¸å†è¯•ç‚¼</button>
          <div id="battleResult" class="hint"></div>
          <div id="battleLog"></div>
        </div>
      </div>

      <!-- å¸‚é›†é¡µ -->
      <div id="pageShop" style="width:100%; display:none;">
        <div class="panel">
          <h2>çµçŸ³å¸‚é›† Â· æ´åºœ</h2>
          <div class="hint">
            å½“å‰çµçŸ³ï¼š<span id="shopSpiritStones">0</span><br>
            æ´åºœä¼šè‡ªåŠ¨å¸æ”¶å¤©åœ°çµæ°”ï¼Œæ˜¯æŒ‚æœºä¿®ç‚¼çš„æ ¸å¿ƒã€‚
          </div>
          <div class="upgrade">
            <div class="upgrade-info">
              è´­ä¹°æ´åºœï¼ˆæ•°é‡å åŠ ï¼‰<br>
              ä»·æ ¼ï¼š<span id="caveCost">0</span> çµçŸ³<br>
              æ´åºœæ•°é‡ï¼š<span id="caveCount">0</span>
            </div>
            <button id="buyCaveBtn">è´­ä¹°æ´åºœ</button>
          </div>
          <div class="upgrade">
            <div class="upgrade-info">
              æ´åºœå“è´¨ï¼š<span id="caveQualitySpan">ç®€é™‹æ´åºœ</span><br>
              å½“å‰æ€»æ´åºœåŠ æˆï¼š<span id="caveQpsSpan">0.0</span> çœŸæ°”/ç§’<br>
              å“è´¨å‡çº§æ¶ˆè€—ï¼š<span id="caveUpgradeCost">0</span> çµçŸ³
            </div>
            <button id="upgradeCaveBtn">å‡çº§æ´åºœå“è´¨</button>
          </div>
          <div class="hint">
            å“è´¨è¶Šé«˜ï¼Œæ¯ä¸€åº§æ´åºœæä¾›çš„çœŸæ°”/ç§’è¶Šå¤šã€‚éƒ¨åˆ†æ¸¸å†å¥‡é‡ä¹Ÿå¯èƒ½ç›´æ¥æå‡æ´åºœå“è´¨ã€‚
          </div>
        </div>

        <div class="panel">
          <h2>çµçŸ³å¸‚é›† Â· ä¸¹è¯</h2>
          <div class="hint">
            ä¸¹è¯ä¸»è¦æå‡æ‰“åæ—¶çš„çœŸæ°”æ”¶ç›Šï¼Œæ˜¯å‰æœŸæå‡ä¿®ä¸ºé€Ÿåº¦çš„é‡è¦æ–¹å¼ã€‚
          </div>
          <div class="upgrade">
            <div class="upgrade-info">
              è´­ä¹°èšæ°”æ•£ä¸€å±‚ï¼ˆæå‡æ‰“åæ”¶ç›Šï¼‰<br>
              ä»·æ ¼ï¼š<span id="pillCost">0</span> çµçŸ³<br>
              ä¸¹è¯å±‚æ•°ï¼š<span id="pillLevel">1</span>
            </div>
            <button id="buyPillBtn">è´­ä¹°ä¸¹è¯</button>
          </div>
          <div class="upgrade">
            <div class="upgrade-info">
              ä¸¹è¯å“è´¨ï¼š<span id="pillQualitySpan">å‡¡å“èšæ°”æ•£</span><br>
              å“è´¨å‡çº§æ¶ˆè€—ï¼š<span id="pillUpgradeCost">0</span> çµçŸ³
            </div>
            <button id="upgradePillBtn">å‡çº§ä¸¹è¯å“è´¨</button>
          </div>

          <!-- â˜… æ–°å¢ï¼šæ´—é«“ä¸¹ï¼ˆé‡æŠ½çµæ ¹ï¼‰ -->
          <div class="upgrade">
            <div class="upgrade-info">
              è´­ä¹°æ´—é«“ä¸¹ï¼ˆé‡å¡‘çµæ ¹ï¼‰<br>
              å•ä»·ï¼š200 çµçŸ³<br>
              åŠŸæ•ˆï¼šæœç”¨åå¯é‡æ–°æŠ½å–ä¸€æ¬¡çµæ ¹ï¼Œæ›¿æ¢å½“å‰çµæ ¹ã€‚
            </div>
            <button id="buyWashRootPillBtn">è´­ä¹°æ´—é«“ä¸¹</button>
          </div>
          <!-- â˜… æ–°å¢ç»“æŸ -->

          <div class="hint">
            å“è´¨è¶Šé«˜ï¼Œæ¯ä¸€å±‚ä¸¹è¯æä¾›çš„é¢å¤–æ‰“åçœŸæ°”è¶Šå¤šã€‚æœªæ¥å¯ä»¥åœ¨æ­¤æ‰©å±•æ›´å¤šä¸¹è¯ä¸åŠŸæ³•ã€‚
          </div>
        </div>

        <div class="panel">
          <h2>çµçŸ³å¸‚é›† Â· æ­¦æŠ€</h2>
          <div class="hint">
            åœ¨æ­¤å¯è´­ä¹°åŸºç¡€æ­¦æŠ€å·è½´ï¼Œä¹ å¾—åå°†åœ¨æˆ˜æ–—ä¸­æä¾›æŒç»­å¢ç›Šã€‚
          </div>
          <div id="shopSkillList" class="hint" style="margin-top:8px;"></div>
        </div>
      </div>

      <!-- åŠŸæ³•é¡µ -->
      <div id="pageSkills" style="width:100%; display:none;">
        <div class="panel">
          <h2>åŠŸæ³•æ€»è§ˆ</h2>
          <div class="hint">
            è¿™é‡Œå¯ä»¥æŸ¥çœ‹ä½ å·²ç»ä¿®ç‚¼çš„å¿ƒæ³•ã€æŒæ¡çš„ç§˜ç±ä¸æ­¦æŠ€ã€‚<br>
            å¿ƒæ³•ä¸çµæ ¹å¥‘åˆï¼Œå¯å¤§å¹…æå‡ä¿®ç‚¼é€Ÿåº¦ï¼›ç§˜ç±ä¸æ­¦æŠ€å¤šåœ¨æˆ˜æ–—ä¸­å‘æŒ¥å¨åŠ›ã€‚
          </div>
          <div id="activeMethodInfo" class="hint" style="margin-top:8px;">
            å½“å‰å°šæœªä¿®ç‚¼ä»»ä½•å¿ƒæ³•ã€‚
          </div>
          <div id="knownSkillsList" class="hint" style="margin-top:8px;"></div>
        </div>
      </div>

      <!-- å®—é—¨é¡µ -->
      <div id="pageSect" style="width:100%; display:none;">
        <div class="panel">
          <h2>å®—é—¨ä¼ æ‰¿</h2>
          <div class="hint">
            ä½ å¯åœ¨æ­¤æ¶ˆè€—çµçŸ³ï¼Œå‘è™šæ‹Ÿå®—é—¨è´­ä¹°/å­¦ä¹ åŠŸæ³•ä¸ç§˜ç±ã€‚<br>
            åŠŸæ³•å¤šä¸ºå¿ƒæ³•ï¼Œæ¿€æ´»çµæ ¹æ½œåŠ›å¹¶æå‡ä¿®ç‚¼é€Ÿåº¦ï¼›ç§˜ç±åˆ™åœ¨æˆ˜æ–—ä¸­å‘æŒ¥å·¨å¤§å¨åŠ›ã€‚<br>
            åªèƒ½å­¦ä¹ ä¸è‡ªèº«çµæ ¹ç›¸ç¬¦çš„å¿ƒæ³•/ç§˜ç±ã€‚
          </div>
          <div id="sectOfferList" class="hint" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
      <div class="nav-item active" data-page="cultivation">
        <div class="nav-icon">â›°ï¸</div>
        <div class="nav-label">ä¿®ç‚¼</div>
      </div>
      <div class="nav-item" data-page="battle">
        <div class="nav-icon">ğŸ§­</div>
        <div class="nav-label">æ¸¸å†</div>
      </div>
      <div class="nav-item" data-page="skills">
        <div class="nav-icon">ğŸ“œ</div>
        <div class="nav-label">åŠŸæ³•</div>
      </div>
      <div class="nav-item" data-page="shop">
        <div class="nav-icon">ğŸ›’</div>
        <div class="nav-label">å¸‚é›†</div>
      </div>
      <div class="nav-item" data-page="sect">
        <div class="nav-icon">â›©ï¸</div>
        <div class="nav-label">å®—é—¨</div>
      </div>
    </div>
  </div>

  <script>
    /* ========== çµæ ¹è®¾å®š & å±‚çº§åŠ æˆï¼ˆåªå½±å“ä¿®ç‚¼ & å¥‡é‡ï¼‰ ========== */

    const LING_ROOTS = [
      // T1
      { id: 'cause',  name: 'å› æœçµæ ¹',  short: 'å› ', tierGroup: 'T1', type: 'special',
        desc: 'ä»¥å› æœä¸ºçº¿ï¼Œç‰µåŠ¨ç»“æœã€‚é€‚åˆã€Œå¤©å‘½æ”¹å†™ã€ã€Œç»“ç•Œåˆ¤å†³ã€ç­‰é«˜ç«¯åŠŸæ³•è·¯çº¿ã€‚' },
      { id: 'time',   name: 'æ—¶é—´çµæ ¹',  short: 'æ—¶', tierGroup: 'T1', type: 'special',
        desc: 'æ„ŸçŸ¥æ—¶é—´æµé€Ÿå˜åŒ–ï¼Œæœªæ¥å¯ä¿®ä¹ ã€Œæ—¶åœã€ã€Œå›æº¯ã€ç­‰é€†å¤©æœ¯å¼ã€‚' },
      { id: 'space',  name: 'ç©ºé—´çµæ ¹',  short: 'ç©º', tierGroup: 'T1', type: 'special',
        desc: 'å¤©ç”Ÿä¸ç©ºé—´æœ‰äº²å’Œï¼Œå¯æŒæ¡ç¬ç§»ã€æŠ˜å ç©ºé—´ã€é¢†åŸŸå‹ç¼©ç­‰èƒ½åŠ›ã€‚' },

      // T2
      { id: 'holy',   name: 'åœ£çµæ ¹',    short: 'åœ£', tierGroup: 'T2', type: 'special',
        desc: 'ç§©åºä¸åº‡æŠ¤çš„è±¡å¾ï¼Œåæ²»ç–—ã€æŠ¤ç›¾ã€å›¢é˜Ÿå¢ç›Šç­‰åœ£èŒè·¯çº¿ã€‚' },
      { id: 'realm',  name: 'ç•Œçµæ ¹',    short: 'ç•Œ', tierGroup: 'T2', type: 'special',
        desc: 'æ“…é•¿æ„ç­‘é¢†åŸŸä¸ç»“ç•Œï¼Œå°†æ¥å¯é•‡å®ˆä¸€æ–¹å°ä¸–ç•Œã€‚' },
      { id: 'light',  name: 'å…‰çµæ ¹',    short: 'å…‰', tierGroup: 'T2', type: 'special',
        desc: 'æŒæ§å…‰ä¸é€Ÿåº¦ï¼Œåå‡€åŒ–ã€çˆ†å‘ä¸é«˜é€Ÿæ–©å‡»ã€‚' },
      { id: 'dark',   name: 'æš—çµæ ¹',    short: 'æš—', tierGroup: 'T2', type: 'special',
        desc: 'ä¸é˜´å½±ã€è…èš€ã€æ½œè¡Œç›¸ä¼´ï¼Œå¯ä¿®æš—å½±æ½œä¼ã€è¯…å’’ç­‰æ­¦æŠ€ã€‚' },

      // T3
      { id: 'dream',  name: 'æ¢¦çµæ ¹',    short: 'æ¢¦', tierGroup: 'T3', type: 'special',
        desc: 'æ¸¸èµ°ç°å®ä¸æ¢¦å¢ƒï¼Œé€‚åˆå¹»æœ¯ã€å¿ƒå¢ƒæ‰°ä¹±ã€å¿ƒé­”åŒ–è§£æ–¹å‘ã€‚' },
      { id: 'spirit', name: 'çµçµæ ¹',    short: 'çµ', tierGroup: 'T3', type: 'special',
        desc: 'çµè§‰æ•é”ï¼Œå¯¹å¤©åœ°æ°”æœºæä¸ºæ•æ„Ÿï¼Œæ“…é•¿æ¢æŸ¥å±æœºä¸æœºç¼˜ã€‚' },
      { id: 'heart',  name: 'å¿ƒçµæ ¹',    short: 'å¿ƒ', tierGroup: 'T3', type: 'special',
        desc: 'å¿ƒæ€§åšéŸ§ï¼Œæƒ…ç»ªå…±é¸£å¼ºçƒˆï¼Œé€‚åˆæ„å¿—å‹åˆ¶ã€æ–—å¿—ç‡ƒçƒ§è·¯çº¿ã€‚' },

      // T4
      { id: 'ice',    name: 'å†°çµæ ¹',    short: 'å†°', tierGroup: 'T4', type: 'special',
        desc: 'ä¸»æŒå¯’å†°å°é”ä¸å‡é€Ÿï¼Œæˆ˜æ–—è¡¨ç°å¼ºåŠ¿ã€‚' },
      { id: 'thunder',name: 'é›·çµæ ¹',    short: 'é›·', tierGroup: 'T4', type: 'special',
        desc: 'é›·éœ†ä¸‡é’§ï¼Œåå¼ºçˆ†å‘ä¸éº»ç—¹æ‰“æ–­ï¼Œæ˜¯å‰æœŸæˆ˜æ–—åˆ©å™¨ã€‚' },

      // T5 äº”è¡Œï¼Œå¯ç»„åˆä¸ºåŒçµæ ¹
      { id: 'metal',  name: 'é‡‘çµæ ¹',    short: 'é‡‘', tierGroup: 'T5', type: 'basic',
        desc: 'é”‹é”æ”»ä¼ä¹‹é“ï¼Œé€‚åˆå‰‘ä¿®ã€æªä¿®ç­‰é”‹é”æµæ´¾ã€‚' },
      { id: 'wood',   name: 'æœ¨çµæ ¹',    short: 'æœ¨', tierGroup: 'T5', type: 'basic',
        desc: 'ç”Ÿé•¿ä¸æ²»æ„ˆä¹‹æœ¬æºï¼Œæ“…é•¿å›å¤ä¸è—¤è”“ç¼ ç»•ã€‚' },
      { id: 'water',  name: 'æ°´çµæ ¹',    short: 'æ°´', tierGroup: 'T5', type: 'basic',
        desc: 'æŸ”éŸ§å¤šå˜ï¼Œå¯å€Ÿæ°´åŠ¿å¸åŠ›ï¼Œåèº«æ³•ä¸åŒ–è§£ã€‚' },
      { id: 'fire',   name: 'ç«çµæ ¹',    short: 'ç«', tierGroup: 'T5', type: 'basic',
        desc: 'çƒ­çƒˆçˆ†è£‚ï¼Œåçˆ†å‘è¾“å‡ºä¸æŒç»­ç¼çƒ§ã€‚' },
      { id: 'earth',  name: 'åœŸçµæ ¹',    short: 'åœŸ', tierGroup: 'T5', type: 'basic',
        desc: 'ç¨³å›ºåšé‡ï¼Œé€‚åˆé˜²å¾¡ã€å²©ç›¾ã€æŠ¤ä½“ç­‰è·¯çº¿ã€‚' }
    ];

    const LING_ROOTS_CONFIG = {
      metal: {
        id: 'metal',
        name: 'é‡‘çµæ ¹',
        tierGroup: 'T5',
        foundationRole: 'æ”»ä¼ä¹‹é”',
        battle: 'ç‰©ç†æ”»å‡»ã€ç ´ç”²ã€æš´å‡»æå‡ï¼Œæ“…é•¿å¿«é€Ÿå‡»æ€ä¸ç ´ç”²è¾“å‡ºã€‚',
        production: 'ç‚¼å™¨ä¸“ç²¾ï¼šæ‰“é€ æ­¦å™¨ã€é˜²å…·æ—¶æˆåŠŸç‡ä¸å“è´¨æå‡ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šçˆ†å‘è¾“å‡º', 'ç”Ÿäº§ï¼šç‚¼å™¨']
      },
      wood: {
        id: 'wood',
        name: 'æœ¨çµæ ¹',
        tierGroup: 'T5',
        foundationRole: 'ç”Ÿæœºä¸æ¢å¤',
        battle: 'æŒç»­æ²»ç–—ã€æŠ¤ç›¾ã€å¸è¡€ç±»æ•ˆæœå¢å¼ºï¼Œé€‚åˆæ‹–é•¿æˆ˜æ–—ã€‚',
        production: 'çµæ¤ç§æ¤ä¸è¯è‰åŸ¹è‚²æ•ˆç‡æé«˜ï¼Œä¸ºç‚¼ä¸¹æä¾›å¤§é‡åŸææ–™ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šç»­èˆªå›å¤', 'ç”Ÿäº§ï¼šç§æ¤/è¯ç”°']
      },
      water: {
        id: 'water',
        name: 'æ°´çµæ ¹',
        tierGroup: 'T5',
        foundationRole: 'æµè½¬ä¸èµ„æº',
        battle: 'å‡é€Ÿã€æµè¡€ã€æŒç»­ä¼¤å®³ç­‰â€œæ¶ˆè€—æˆ˜â€èƒ½åŠ›çªå‡ºã€‚',
        production: 'ç‚¼ä¸¹è¾…åŠ©ï¼šé™ä½ç‚¼ä¸¹å¤±è´¥ç‡ï¼Œé€‚åˆé‡äº§ä½ä¸­é˜¶ä¸¹è¯ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šæ¶ˆè€—æ§åœº', 'ç³»ç»Ÿï¼šæŒ‚æœº/æ‰è½åŠ æˆé¢„ç•™']
      },
      fire: {
        id: 'fire',
        name: 'ç«çµæ ¹',
        tierGroup: 'T5',
        foundationRole: 'çˆ†å‘ä¸å±é™©',
        battle: 'é«˜çˆ†å‘èŒƒå›´ä¼¤å®³ï¼Œæ¸…æ€ªæ•ˆç‡æé«˜ï¼Œä½†å®¹æ˜“è‡ªä¼¤æˆ–èµ°ç«å…¥é­”ã€‚',
        production: 'é«˜æ¸©ç›¸å…³çš„ç‚¼å™¨ã€ç‚¼ä¸¹æœ‰é¢å¤–ç«å€™æŒæ§åŠ æˆã€‚',
        systemTags: ['æˆ˜æ–—ï¼šé«˜çˆ†AOE', 'ç³»ç»Ÿï¼šå¿ƒé­”/é£é™©ç©æ³•é’©å­']
      },
      earth: {
        id: 'earth',
        name: 'åœŸçµæ ¹',
        tierGroup: 'T5',
        foundationRole: 'é˜²å¾¡ä¸ç¨³å›º',
        battle: 'é˜²å¾¡ã€å‡ä¼¤ã€æ ¼æŒ¡ã€åä¼¤å¼ºåŒ–ï¼Œé€‚åˆä½œä¸ºå‰æ’è‚‰ç›¾ã€‚',
        production: 'é‡‡çŸ¿ä¸æŒ–å®æ”¶ç›Šæé«˜ï¼Œé€‚åˆæŒ–æ˜åœ°åº•ç§˜å¢ƒä¸çŸ¿è„‰ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šå¦å…‹/åä¼¤', 'ç³»ç»Ÿï¼šæ¢ç´¢/çŸ¿è—']
      },

      ice: {
        id: 'ice',
        name: 'å†°çµæ ¹',
        tierGroup: 'T4',
        foundationRole: 'æ§åˆ¶ä¸“å®¶',
        battle: 'å†»ç»“ã€å‡é€Ÿã€æ˜“ä¼¤ç­‰ç¾¤ä½“æ§åˆ¶å¼ºåŠ¿ï¼Œé€‚åˆé«˜éš¾ç§˜å¢ƒæ§åœºã€‚',
        production: 'æš‚æ— ä¸“å±ç”Ÿäº§åŠ æˆï¼Œå¯ä¸æ°´/åœŸç³»ç©æ³•è”åŠ¨ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šå¼ºæ§/å‡é€Ÿ']
      },
      thunder: {
        id: 'thunder',
        name: 'é›·çµæ ¹',
        tierGroup: 'T4',
        foundationRole: 'é«˜é€Ÿçˆ†ç ´',
        battle: 'æ”»é€Ÿã€è¿å‡»ã€é—ªç”µé“¾æ¡ä¼¤å®³ï¼Œæ¸…å›¾ä¸å¤šç›®æ ‡ä½œæˆ˜å¼ºã€‚',
        production: 'æ¶ˆè€—å“ä¸ç¬¦ç¯†ç±»é“å…·å¯ç»‘å®šâ€œé›·å‡»â€ç‰¹æ•ˆã€‚',
        systemTags: ['æˆ˜æ–—ï¼šé«˜é¢‘è¾“å‡º', 'ç³»ç»Ÿï¼šé«˜æ¶ˆè€—é«˜æ”¶ç›Š']
      },
      heart: {
        id: 'heart',
        name: 'å¿ƒçµæ ¹',
        tierGroup: 'T3',
        foundationRole: 'æ‚Ÿæ€§ä¸å¿ƒå¢ƒ',
        battle: 'å¿ƒå¢ƒç±»æŠ€èƒ½å¼ºåŒ–ï¼Œå¯¹å¿ƒé­”ã€ææƒ§ã€æ··ä¹±ç­‰çŠ¶æ€æ›´ç¨³å®šã€‚',
        production: 'å¿ƒæ³•ç»éªŒä¸æ‚Ÿæ€§åŠ æˆï¼Œæ›´æ˜“è§£é”æ–°æŠ€èƒ½æˆ–éšè—æŠ€ã€‚',
        systemTags: ['ç³»ç»Ÿï¼šæ‚Ÿæ€§/å¤©èµ‹æ ‘', 'äº‹ä»¶ï¼šå¿ƒé­”/æ¸¡åŠ«åŠ æˆ']
      },
      spirit: {
        id: 'spirit',
        name: 'çµçµæ ¹',
        tierGroup: 'T3',
        foundationRole: 'çµå® ä¸è‡ªåŠ¨åŒ–',
        battle: 'å¬å”¤çµå® ã€çµä»†ã€å‚€å„¡æµï¼Œåå¤šå•ä½ä½œæˆ˜ã€‚',
        production: 'çµå® å¯ä»£æ›¿ç©å®¶æ‰§è¡Œé‡‡é›†ã€ç§æ¤ç­‰â€œè‡ªåŠ¨åŒ–â€ä»»åŠ¡ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šå¬å”¤æµ', 'ç³»ç»Ÿï¼šæŒ‚æœº/è‡ªåŠ¨å¯»å®']
      },
      dream: {
        id: 'dream',
        name: 'æ¢¦çµæ ¹',
        tierGroup: 'T3',
        foundationRole: 'æ¢¦å¢ƒä¸ç¦»çº¿æ”¶ç›Š',
        battle: 'å¹»æœ¯ã€è¿·æƒ‘ã€é™å‘½ä¸­ç­‰è™šå®éš¾è¾¨çš„æ¢¦å¢ƒç³»èƒ½åŠ›ã€‚',
        production: 'ç¦»çº¿æ”¶ç›Šå€ç‡æå‡ï¼Œå¯å¼€å¯â€œæ¢¦å¢ƒç§˜å¢ƒâ€ï¼ˆç¦»çº¿æ¨è¿›ç©æ³•ï¼‰ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šå¹»æœ¯/æ§åˆ¶', 'ç³»ç»Ÿï¼šç¦»çº¿æ”¶ç›Š']
      },

      dark: {
        id: 'dark',
        name: 'æš—çµæ ¹',
        tierGroup: 'T2',
        foundationRole: 'é«˜é£é™©é«˜æ”¶ç›Š',
        battle: 'æ®‹è¡€å¢ä¼¤ã€æš—å±æ€§çœŸä¼¤ç­‰ï¼Œè¶Šå±æ€¥è¶Šå¼ºã€‚',
        production: 'é€‚åˆç‚¼åˆ¶ç¦è¯ã€é‚ªå™¨ç­‰é«˜é£é™©äº§ç‰©ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šæå‘½æµ', 'ç³»ç»Ÿï¼šå •è½/ç†æ€§å€¼ç©æ³•']
      },
      light: {
        id: 'light',
        name: 'å…‰çµæ ¹',
        tierGroup: 'T2',
        foundationRole: 'ä¿å‘½ä¸è§£å„',
        battle: 'æŠ¤ç›¾ã€å‡€åŒ–ã€å¤æ´»ã€å›¢é˜Ÿå¢ç›Šï¼Œä¸ºå¼ºåŠ›è¾…åŠ©å‘çµæ ¹ã€‚',
        production: 'ä¸â€œä¿åº•â€â€œå¹¸è¿â€ç±»æœºåˆ¶ç»‘å®šï¼Œé™ä½å¤±è´¥æƒ©ç½šã€‚',
        systemTags: ['æˆ˜æ–—ï¼šå¥¶/ä¿æŠ¤', 'ç³»ç»Ÿï¼šä¿åº•/è§£å„']
      },
      realm: {
        id: 'realm',
        name: 'ç•Œçµæ ¹',
        tierGroup: 'T2',
        foundationRole: 'ç§˜å¢ƒä¸åœ°å›¾æ”¯é…',
        battle: 'åœ¨ç§˜å¢ƒå†…è·å¾—é¢†åŸŸåŠ æˆï¼Œå¯æ”¹å˜åœ°å½¢ä¸æˆ˜åœºè§„åˆ™ã€‚',
        production: 'ç§˜å¢ƒèµ„æºé‡‡é›†åŠ æˆï¼Œæ˜¯æ¢é™©å®¶ä¸å¼€å›¾å…šçš„æœ€çˆ±ã€‚',
        systemTags: ['ç³»ç»Ÿï¼šåœ°å›¾/ç§˜å¢ƒ/é¢†åŸŸ']
      },
      holy: {
        id: 'holy',
        name: 'åœ£çµæ ¹',
        tierGroup: 'T2',
        foundationRole: 'æ°”è¿ä¸åº‡æŠ¤',
        battle: 'å‡å¼±å¤©åŠ«ã€å¿ƒé­”ç­‰æƒ©ç½šï¼Œè¾…åŠ©ä¸åº‡æŠ¤å‹èƒ½åŠ›çªå‡ºã€‚',
        production: 'å¥‡é‡ã€ä»»åŠ¡å“è´¨ã€NPCå¥½æ„Ÿç­‰äº‹ä»¶æƒé‡æå‡ã€‚',
        systemTags: ['ç³»ç»Ÿï¼šæ°”è¿/å¥‡é‡', 'äº‹ä»¶ï¼šæ¸¡åŠ«å‡ä¼¤']
      },

      space: {
        id: 'space',
        name: 'ç©ºé—´çµæ ¹',
        tierGroup: 'T1',
        foundationRole: 'ä½ç½®ä¸æ ¼å±€',
        battle: 'ç¬ç§»ã€ä½ç§»ã€é—ªé¿ä¸æ‹‰æ‰¯ï¼Œææ“…é•¿èµ°ä½ä¸é£ç­ã€‚',
        production: 'èƒŒåŒ…æ ¼å­ã€ä»“åº“ã€çµå® æ ç­‰â€œç©ºé—´ä½â€ä¸Šé™æå‡ã€‚',
        systemTags: ['æˆ˜æ–—ï¼šä½ç§»/é—ªé¿', 'ç³»ç»Ÿï¼šæ ¼å­/é¢å¤–æ§½ä½']
      },
      time: {
        id: 'time',
        name: 'æ—¶é—´çµæ ¹',
        tierGroup: 'T1',
        foundationRole: 'åŠ é€Ÿä¸å‹ç¼©',
        battle: 'ç¼©çŸ­å†·å´ã€åŠ å¿«æŒç»­ä¼¤å®³/æ²»ç–— Tickï¼Œæ—¶é—´å‡é€Ÿæ§åˆ¶ã€‚',
        production: 'ä¿®ç‚¼ã€ç‚¼ä¸¹ã€å»ºé€ ç­‰è€—æ—¶è¡Œä¸ºæ•´ä½“åŠ é€Ÿï¼Œä½†èµ„æºæ¶ˆè€—ä¹Ÿæ›´å¿«ã€‚',
        systemTags: ['ç³»ç»Ÿï¼šå…¨å±€åŠ é€Ÿ', 'æˆ˜æ–—ï¼šå†·å´ç¼©å‡']
      },
      cause: {
        id: 'cause',
        name: 'å› æœçµæ ¹',
        tierGroup: 'T1',
        foundationRole: 'è½®å›ä¸é€†å¤©æ”¹å‘½',
        battle: 'å‰æœŸæ•°å€¼å¹³å¹³ï¼Œä¸­åæœŸä¸è½®å›/å› æœç‚¹ç³»ç»Ÿæ·±åº¦ç»‘å®šã€‚',
        production: 'å¯é‡ç½®çµæ ¹ã€åŠŸæ³•ã€å¤©èµ‹ä»¥â€œæ´—ç‰Œâ€ï¼Œä¿ç•™å› æœåŠ æˆã€‚',
        systemTags: ['ç³»ç»Ÿï¼šè½®å›/æ´—ç»ƒ/ç»ˆå±€æˆé•¿']
      }
    };

    const DUAL_BASIC_RELATIONS = {
      'metal-wood': {
        title: 'é‡‘æœ¨åŒä¿®',
        desc: 'é‡‘å±ä¹‹é”ä¸æœ¨ä¹‹ç”Ÿé•¿å¹¶å­˜ï¼Œé€‚åˆèµ°æ”»å®ˆå…¼å¤‡è·¯çº¿ï¼Œå‰æœŸè¾“å‡ºé¡ºæ»‘ï¼Œä¸­åæœŸæˆé•¿ç¨³å®šã€‚'
      },
      'metal-water': {
        title: 'é‡‘æ°´çŒé”‹',
        desc: 'é‡‘ä¸»æ€ä¼ï¼Œæ°´ä¸»èµ„æºï¼Œæ—¢èƒ½æ‰“å‡»æ•Œäººï¼Œåˆåå‘æ‰è½ä¸èµ„æºè·å–ï¼Œæ˜¯â€œæ‰“å·¥ä¿®ä»™â€çš„å¸¸è§ä½“è´¨ã€‚'
      },
      'metal-fire': {
        title: 'ç‚é‡‘ç‚¼ç‹±',
        desc: 'é”‹åˆƒå ç«ï¼Œçˆ†å‘æé«˜ï¼Œä½†ä¿®è¡Œè·¯ä¸Šæ›´å®¹æ˜“èµ°ç«å…¥é­”ï¼Œé€‚åˆè¿½æ±‚æè‡´è¾“å‡ºçš„ç–¯æ‰¹å‰‘ä¿®ã€‚'
      },
      'metal-earth': {
        title: 'å±±å²³é‡‘åˆš',
        desc: 'åœŸä¹‹ç¨³å›ºæ‰˜ä¸¾é‡‘ä¹‹æ”»å‡»ï¼Œæ”»é˜²å…¼å¤‡ï¼Œé€‚åˆå‰æ’ã€å¦åˆ€æµä¿®å£«ï¼Œæˆ˜åŠ›æ‰å®ã€‚'
      },
      'wood-water': {
        title: 'çµæœ¨ç”˜æ³‰',
        desc: 'æœ¨ä¸»ç”Ÿæœºï¼Œæ°´ä¸»æ»‹å…»ï¼Œå›å¤ä¸ç»­èˆªèƒ½åŠ›æä½³ï¼Œé€‚åˆåŒ»ç”Ÿã€è¾…åŠ©ã€é•¿çº¿å…»æˆæµã€‚'
      },
      'wood-fire': {
        title: 'ç„šæ—ç‡ƒæœ¨',
        desc: 'æœ¨ä¸ºè–ªæŸ´ï¼Œç«å€Ÿæœ¨åŠ¿ï¼Œçˆ†å‘ä¸èŒƒå›´ä¼¤å®³éƒ½å¼ºåŠ›ï¼Œä½†èµ„æºæ¶ˆè€—åé«˜ï¼Œå¯¹ç©å®¶æ“ä½œä¸è§„åˆ’è¦æ±‚æ›´é«˜ã€‚'
      },
      'wood-earth': {
        title: 'é’è—¤å›ºå²­',
        desc: 'æœ¨åœŸå¹¶ç”Ÿï¼Œå¦‚è—¤ç¼ å±±ï¼Œåå‘æ§åˆ¶ä¸é˜²å®ˆï¼Œé€‚åˆé˜µåœ°æˆ˜ã€å®ˆç‚¹ç±»ç©æ³•ã€‚'
      },
      'water-fire': {
        title: 'å¯’ç‚ç›¸æµ',
        desc: 'å†·çƒ­äº¤æ›¿ï¼Œæ”»å®ˆä¸€ä½“ï¼Œæ—¢èƒ½æ‰“è¾“å‡ºåˆèƒ½æ§åœºï¼Œæ“ä½œä¸Šæ›´è€ƒéªŒèŠ‚å¥æ„Ÿã€‚'
      },
      'water-earth': {
        title: 'æ²¼æ³½çŸ¿è„‰',
        desc: 'æ°´æ¶¦åœŸã€åœŸè½½æ°´ï¼Œåå‘å‡é€Ÿã€æŸç¼šä¸èµ„æºæœé›†ï¼Œåœ¨æ¢ç´¢ä¸æŒ–å®ç©æ³•ä¸­è¡¨ç°çªå‡ºã€‚'
      },
      'fire-earth': {
        title: 'ç†”å²©å£å’',
        desc: 'ç«ç‚¼åœŸæˆå²©ï¼Œæ”»é˜²ä¸€ä½“ï¼Œé€‚åˆç«™æ¡©è¾“å‡ºä¸åå‡»æµæ´¾ï¼Œåœ¨é«˜å‹æˆ˜æ–—ä¸­å°¤ä¸ºç¨³å®šã€‚'
      }
    };

    const LING_TIER_META = {
      none:       { label: 'æ— çµæ ¹åŠ æˆ',         qiMult: 1.0,  abilityMult: 1.0, eventMult: 1.0 },
      T1:         { label: 'T1 è¶…é™çµæ ¹',       qiMult: 3.0,  abilityMult: 2.5, eventMult: 2.5 },
      T2:         { label: 'T2 é«˜ç»´è§„åˆ™çµæ ¹',   qiMult: 2.2,  abilityMult: 1.4, eventMult: 1.6 },
      T3:         { label: 'T3 çµæ€§/æ„è¯†çµæ ¹',  qiMult: 2.0,  abilityMult: 1.0, eventMult: 1.4 },
      T4:         { label: 'T4 è‡ªç„¶æˆ˜æ–—çµæ ¹',   qiMult: 1.4,  abilityMult: 1.0, eventMult: 1.0 },
      T5_single:  { label: 'T5 å•äº”è¡Œçµæ ¹',     qiMult: 1.0,  abilityMult: 1.0, eventMult: 1.0 },
      T5_double:  { label: 'T5 åŒäº”è¡Œçµæ ¹',     qiMult: 1.25, abilityMult: 1.0, eventMult: 1.0 }
    };

    function getBasicRoots()  { return LING_ROOTS.filter(r => r.type === 'basic'); }
    function getSpecialRoots(){ return LING_ROOTS.filter(r => r.type === 'special'); }

    function getDualBasicRelation(roots) {
      if (!roots || roots.length !== 2) {
        return { type: 'neutral', label: 'T5 åŒçµæ ¹', descExtra: '', comboName: '' };
      }
      const [r1, r2] = roots;
      if (r1.type !== 'basic' || r2.type !== 'basic') {
        return { type: 'neutral', label: 'T5 åŒçµæ ¹', descExtra: '', comboName: '' };
      }
      const a = r1.id, b = r2.id;

      function match(p1, p2) {
        return (a === p1 && b === p2) || (a === p2 && b === p1);
      }

      let relType = 'neutral';
      let label = 'T5 åŒçµæ ¹';
      let descExtra = 'ä¸¤ç§äº”è¡Œå¹¶å­˜ï¼Œæ—¢æœ‰å¤šæ ·å˜åŒ–ï¼Œä¹Ÿéœ€è°¨æ…è°ƒå’Œã€‚';

      // ç›¸ç”Ÿï¼šæœ¨ç«ã€ç«åœŸã€åœŸé‡‘ã€é‡‘æ°´ã€æ°´æœ¨
      if (match('wood', 'fire') || match('fire', 'earth') || match('earth', 'metal')
        || match('metal', 'water') || match('water', 'wood')) {
        relType = 'synergy';
        label = 'T4.5 ç›¸ç”ŸåŒçµæ ¹';
        descExtra = 'ä¸¤ç§äº”è¡Œç›¸ç”Ÿï¼Œä¿®è¡Œè·¯é€”æ›´é¡ºæ»‘ï¼Œèƒ½åŠ›ç‚¹è·å–ç•¥æœ‰æå‡ã€‚';
      }
      // ç›¸å…‹ï¼šé‡‘æœ¨ï¼Œæœ¨åœŸï¼ŒåœŸæ°´ï¼Œæ°´ç«ï¼Œç«é‡‘
      else if (match('metal', 'wood') || match('wood', 'earth') || match('earth', 'water')
        || match('water', 'fire') || match('fire', 'metal')) {
        relType = 'clash';
        label = 'T5 ç›¸å…‹åŒçµæ ¹';
        descExtra = 'ä¸¤ç§äº”è¡Œç›¸å…‹ï¼Œä¿®è¡Œè·¯ä¸Šæ³¢æ¾œä¸æ–­ï¼Œå´æ›´å®¹æ˜“æ¿€å‘å‘½è¿æ³¢åŠ¨ä¸å¥‡é‡ã€‚';
      }

      let comboName = '';
      const key = [a, b].sort().join('-');
      const cfg = DUAL_BASIC_RELATIONS[key];
      if (cfg) {
        if (cfg.title) comboName = cfg.title;
        if (cfg.desc) descExtra = cfg.desc;
      }

      return { type: relType, label, descExtra, comboName };
    }

    function getLingRootTierMeta() {
      if (!lingRoots || lingRoots.length === 0) return LING_TIER_META.none;

      const hasSpecial = lingRoots.some(r => r.type === 'special');
      if (hasSpecial) {
        const order = ['T1', 'T2', 'T3', 'T4'];
        let bestTier = 'T4';
        let bestIndex = order.length;
        lingRoots.forEach(r => {
          if (r.type === 'special') {
            const idx = order.indexOf(r.tierGroup);
            if (idx !== -1 && idx < bestIndex) {
              bestIndex = idx;
              bestTier = r.tierGroup;
            }
          }
        });
        const meta = { ...LING_TIER_META[bestTier] };
        return meta;
      } else {
        if (lingRoots.length >= 2) {
          const meta = { ...LING_TIER_META.T5_double };
          const rel = getDualBasicRelation(lingRoots);
          if (rel.type === 'synergy') {
            meta.abilityMult *= 1.2;
          } else if (rel.type === 'clash') {
            meta.eventMult *= 1.2;
          }
          return meta;
        }
        return LING_TIER_META.T5_single;
      }
    }

    function getLingRootDisplayNameFrom(roots) {
      if (!roots || roots.length === 0) return 'æœªè§‰é†’';
      if (roots.length === 1) return roots[0].name;
      const bothBasic = roots.every(r => r.type === 'basic');
      if (bothBasic) {
        return `${roots[0].short}${roots[1].short}åŒçµæ ¹`;
      }
      return roots.map(r => r.name).join(' / ');
    }

    function getLingRootDisplayName() {
      return getLingRootDisplayNameFrom(lingRoots);
    }

    const ROOT_COLOR_CLASS_MAP = {
      cause:   'root-color-cause',
      time:    'root-color-time',
      space:   'root-color-space',
      holy:    'root-color-holy',
      realm:   'root-color-realm',
      light:   'root-color-light',
      dark:    'root-color-dark',
      dream:   'root-color-dream',
      spirit:  'root-color-spirit',
      heart:   'root-color-heart',
      ice:     'root-color-ice',
      thunder: 'root-color-thunder',
      metal:   'root-color-metal',
      wood:    'root-color-wood',
      water:   'root-color-water',
      fire:    'root-color-fire',
      earth:   'root-color-earth'
    };

    const ROOT_COLOR_CLASS_LIST = Object.values(ROOT_COLOR_CLASS_MAP);

    function applyLingRootColor(el, roots) {
      if (!el) return;
      ROOT_COLOR_CLASS_LIST.forEach(c => el.classList.remove(c));
      if (!roots || roots.length === 0) return;
      const first = roots[0];
      const cls = ROOT_COLOR_CLASS_MAP[first.id];
      if (cls) el.classList.add(cls);
    }

    // æŠ½çµæ ¹ï¼š15% ç¨€æœ‰å•çµæ ¹ï¼›å…¶ä½™ä¸ºå•/åŒäº”è¡Œ
    function generateLingRoots() {
      const specialPool = getSpecialRoots();
      const basicPool = getBasicRoots();
      const roll = Math.random();

      if (roll < 0.15) {
        const idx = Math.floor(Math.random() * specialPool.length);
        return [specialPool[idx]];
      } else {
        const r2 = Math.random();
        if (r2 < 0.4) {
          const idx = Math.floor(Math.random() * basicPool.length);
          return [basicPool[idx]];
        } else {
          const idx1 = Math.floor(Math.random() * basicPool.length);
          let idx2 = Math.floor(Math.random() * basicPool.length);
          while (idx2 === idx1) idx2 = Math.floor(Math.random() * basicPool.length);
          return [basicPool[idx1], basicPool[idx2]];
        }
      }
    }

    /* ========== åŠŸæ³• / ç§˜ç± / æ­¦æŠ€ å®šä¹‰ ========== */

    const SKILL_RARITY_META = {
      common:    { label: 'å‡¡å“', className: 'skill-rarity-common' },
      uncommon:  { label: 'ç½•è§', className: 'skill-rarity-uncommon' },
      rare:      { label: 'ç¨€æœ‰', className: 'skill-rarity-rare' },
      epic:      { label: 'çå“', className: 'skill-rarity-epic' },
      legendary: { label: 'ç»å“', className: 'skill-rarity-legendary' },
      mythic:    { label: 'ä»™æ³•', className: 'skill-rarity-mythic' }
    };

    // åŠŸæ³• / ç§˜ç± / æ­¦æŠ€ å®šä¹‰
    // type: method=å¿ƒæ³•, manual=ç§˜ç±, technique=æ­¦æŠ€
    // source: sect / sectAndDrop / shop / shopAndDrop / drop
    const ALL_SKILLS = {
      /* ======================
       *  T1 è¶…é™çµæ ¹ Â· å¿ƒæ³•
       * ====================== */

      method_cause_silk: {
        id: 'method_cause_silk',
        name: 'å¿ƒæ³•Â·å› æœç‰µä¸',
        type: 'method',
        rarity: 'mythic',
        source: 'sect',
        price: 100000,
        qiSpeedBonus: 0.5,
        requirement: {
          type: 'rootAnyOf',
          ids: ['cause']
        },
        desc: 'ä»¥å¿ƒå¿µä¸ºä¸ï¼Œå‹¾è¿å¤©åœ°å› æœã€‚é™å®šå› æœçµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +50%ã€‚'
      },

      method_time_flow: {
        id: 'method_time_flow',
        name: 'å¿ƒæ³•Â·æ—¶å¦‚å¿ƒæµ',
        type: 'method',
        rarity: 'mythic',
        source: 'sect',
        price: 100000,
        qiSpeedBonus: 0.5,
        requirement: {
          type: 'rootAnyOf',
          ids: ['time']
        },
        desc: 'æ—¶é—´å¦‚å¿ƒä¸­æºªæµï¼Œå¿µèµ·å³æµè½¬ã€‚é™å®šæ—¶é—´çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +50%ã€‚'
      },

      method_space_fold: {
        id: 'method_space_fold',
        name: 'å¿ƒæ³•Â·ç©ºç›¸æŠ˜å ',
        type: 'method',
        rarity: 'mythic',
        source: 'sect',
        price: 100000,
        qiSpeedBonus: 0.5,
        requirement: {
          type: 'rootAnyOf',
          ids: ['space']
        },
        desc: 'æ„Ÿæ‚Ÿä¸‡ç‰©ã€Œç©ºç›¸ã€ï¼ŒæŠ˜å ç©ºé—´è„‰ç»œã€‚é™å®šç©ºé—´çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +50%ã€‚'
      },

      /* ======================
       *  T2 é«˜ç»´è§„åˆ™çµæ ¹ Â· å¿ƒæ³•
       * ====================== */

      method_holy_radiance: {
        id: 'method_holy_radiance',
        name: 'å¿ƒæ³•Â·åœ£è¾‰åŒå°˜è¯€',
        type: 'method',
        rarity: 'legendary',
        source: 'sect',
        price: 60000,
        qiSpeedBonus: 0.4,
        requirement: {
          type: 'rootAnyOf',
          ids: ['holy']
        },
        desc: 'åœ£è¾‰å…¥å°˜ï¼Œä¸æŸ“ä¸€å°˜ã€‚é™å®šåœ£çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +40%ã€‚'
      },

      method_realm_pillar: {
        id: 'method_realm_pillar',
        name: 'å¿ƒæ³•Â·ç•Œé•‡å¯°å®‡',
        type: 'method',
        rarity: 'legendary',
        source: 'sect',
        price: 60000,
        qiSpeedBonus: 0.4,
        requirement: {
          type: 'rootAnyOf',
          ids: ['realm']
        },
        desc: 'ä»¥è‡ªèº«ä¸ºç•ŒæŸ±ï¼Œé•‡å‹ä¸€åŸŸæ°”æœºã€‚é™å®šç•Œçµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +40%ã€‚'
      },

      method_light_purify: {
        id: 'method_light_purify',
        name: 'å¿ƒæ³•Â·å…‰æ›œå‡€ä¸–ç¯‡',
        type: 'method',
        rarity: 'legendary',
        source: 'sect',
        price: 60000,
        qiSpeedBonus: 0.4,
        requirement: {
          type: 'rootAnyOf',
          ids: ['light']
        },
        desc: 'çº³ä¸‡ç‰©ä¹‹å…‰å…¥ä½“ï¼Œå¿ƒå¿µæ‰€åŠçš†ä¸ºæœ—ç…§ã€‚é™å®šå…‰çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +40%ã€‚'
      },

      method_dark_abyss: {
        id: 'method_dark_abyss',
        name: 'å¿ƒæ³•Â·å¹½å½±å…¥æ¸Šå…¸',
        type: 'method',
        rarity: 'legendary',
        source: 'sect',
        price: 60000,
        qiSpeedBonus: 0.4,
        requirement: {
          type: 'rootAnyOf',
          ids: ['dark']
        },
        desc: 'æ”¶æ•›ä¸‡è±¡ä¹‹å…‰ï¼Œæ²‰å¿ƒå…¥æ¸Šã€‚é™å®šæš—çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +40%ã€‚'
      },

      /* ======================
       *  T3 çµæ€§ / æ„è¯†çµæ ¹ Â· å¿ƒæ³•
       * ====================== */

      method_dream_illusion: {
        id: 'method_dream_illusion',
        name: 'å¿ƒæ³•Â·æ¢¦è¡Œä¸‡æ™¯å½•',
        type: 'method',
        rarity: 'epic',
        source: 'sect',
        price: 35000,
        qiSpeedBonus: 0.33,
        requirement: {
          type: 'rootAnyOf',
          ids: ['dream']
        },
        desc: 'ç¡æ¢¦ä¸­è¸éåƒå±±ä¸‡æ°´ï¼Œäºè™šå¦„å¤„æ‚ŸçœŸã€‚é™å®šæ¢¦çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +33%ã€‚'
      },

      method_spirit_listen: {
        id: 'method_spirit_listen',
        name: 'å¿ƒæ³•Â·çµå¬ä¸‡æœºè¯€',
        type: 'method',
        rarity: 'epic',
        source: 'sect',
        price: 35000,
        qiSpeedBonus: 0.33,
        requirement: {
          type: 'rootAnyOf',
          ids: ['spirit']
        },
        desc: 'ä»¥çµè¯†è†å¬å¤©åœ°ç»†è¯­ã€‚é™å®šçµçµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +33%ã€‚'
      },

      method_heart_mirror: {
        id: 'method_heart_mirror',
        name: 'å¿ƒæ³•Â·ä¸åŠ¨å¿ƒé•œç¯‡',
        type: 'method',
        rarity: 'epic',
        source: 'sect',
        price: 35000,
        qiSpeedBonus: 0.33,
        requirement: {
          type: 'rootAnyOf',
          ids: ['heart']
        },
        desc: 'å¿ƒå¦‚æ˜é•œï¼Œç…§è§ä¸‡è±¡è€Œä¸ç•™ç—•ã€‚é™å®šå¿ƒçµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +33%ã€‚'
      },

      /* ======================
       *  T4 è‡ªç„¶æˆ˜æ–—çµæ ¹ Â· å¿ƒæ³•
       * ====================== */

      method_ice_frostheart: {
        id: 'method_ice_frostheart',
        name: 'å¿ƒæ³•Â·å¯’é­„å‡éœœç« ',
        type: 'method',
        rarity: 'rare',
        source: 'sect',
        price: 20000,
        qiSpeedBonus: 0.28,
        requirement: {
          type: 'rootAnyOf',
          ids: ['ice']
        },
        desc: 'ä»¥å¿ƒç¥ä¸ºéœœé­„ï¼Œä»¤çœŸæ°”æ„ˆå‘æ¸…å†·å‡ç»ƒã€‚é™å®šå†°çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +28%ã€‚'
      },

      method_thunder_tempest: {
        id: 'method_thunder_tempest',
        name: 'å¿ƒæ³•Â·é›·åŠ¨ä¹éœ„å·',
        type: 'method',
        rarity: 'rare',
        source: 'sect',
        price: 20000,
        qiSpeedBonus: 0.28,
        requirement: {
          type: 'rootAnyOf',
          ids: ['thunder']
        },
        desc: 'ä»¥é›·æ„æ·¬ç‚¼ç»è„‰ï¼Œä»¤çœŸæ°”å¥”æ¶Œå¦‚éœ¹é›³ã€‚é™å®šé›·çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +28%ã€‚'
      },

      /* ======================
       *  T5 äº”è¡Œå•çµæ ¹ Â· å¿ƒæ³•
       * ====================== */

      method_metal_edge: {
        id: 'method_metal_edge',
        name: 'å¿ƒæ³•Â·é‡‘é”‹æ–©ç©ºè¯€',
        type: 'method',
        rarity: 'uncommon',
        source: 'sect',
        price: 12000,
        qiSpeedBonus: 0.22,
        requirement: {
          type: 'rootAnyOf',
          ids: ['metal']
        },
        desc: 'ä»¥é‡‘æ€§é”‹é”åˆ‡å‰Šæ‚è´¨ï¼Œä½¿çœŸæ°”ç²¾çº¯ã€‚é™å®šé‡‘çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +22%ã€‚'
      },

      method_wood_vitality: {
        id: 'method_wood_vitality',
        name: 'å¿ƒæ³•Â·æœ¨ç”Ÿä¸‡è±¡ç¯‡',
        type: 'method',
        rarity: 'uncommon',
        source: 'sect',
        price: 12000,
        qiSpeedBonus: 0.22,
        requirement: {
          type: 'rootAnyOf',
          ids: ['wood']
        },
        desc: 'å€Ÿæœ¨æ€§ç”Ÿé•¿ä¹‹åŠ›ï¼Œä½¿çœŸæ°”æºæºä¸ç»ã€‚é™å®šæœ¨çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +22%ã€‚'
      },

      method_water_stream: {
        id: 'method_water_stream',
        name: 'å¿ƒæ³•Â·æ°´è½¬åƒæµæ³•',
        type: 'method',
        rarity: 'uncommon',
        source: 'sect',
        price: 12000,
        qiSpeedBonus: 0.22,
        requirement: {
          type: 'rootAnyOf',
          ids: ['water']
        },
        desc: 'ä»¥æ°´æ€§åœ†èï¼Œå¼•å¯¼çœŸæ°”åœ¨ä½“å†…å‘¨å¤©å¾ªç¯ã€‚é™å®šæ°´çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +22%ã€‚'
      },

      method_fire_flame: {
        id: 'method_fire_flame',
        name: 'å¿ƒæ³•Â·èµ¤ç„°ç„šå¿ƒè¯€',
        type: 'method',
        rarity: 'uncommon',
        source: 'sect',
        price: 12000,
        qiSpeedBonus: 0.22,
        requirement: {
          type: 'rootAnyOf',
          ids: ['fire']
        },
        desc: 'ä»¥ç‚½çƒˆç«ç„°ç„šå°½æ‚å¿µï¼ŒçœŸæ°”éšä¹‹æ—ºç››ã€‚é™å®šç«çµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +22%ã€‚'
      },

      method_earth_barrier: {
        id: 'method_earth_barrier',
        name: 'å¿ƒæ³•Â·åšåœŸè½½å…ƒç¯‡',
        type: 'method',
        rarity: 'uncommon',
        source: 'sect',
        price: 12000,
        qiSpeedBonus: 0.22,
        requirement: {
          type: 'rootAnyOf',
          ids: ['earth']
        },
        desc: 'ä»¥åšåœŸæ‰¿è½½çœŸå…ƒï¼Œä½¿æ ¹åŸºæ„ˆå‘ç¨³å›ºã€‚é™å®šåœŸçµæ ¹è€…ä¿®ç‚¼ï¼Œä¿®ç‚¼é€Ÿåº¦ +22%ã€‚'
      },

      /* ======================
       *  é€šç”¨äº”è¡Œå¿ƒæ³•
       * ====================== */

      method_five_cycle: {
        id: 'method_five_cycle',
        name: 'å¿ƒæ³•Â·äº”è¡Œå¾ªç¯è¯€',
        type: 'method',
        rarity: 'rare',
        source: 'sect',
        price: 8000,
        qiSpeedBonus: 0.2,
        requirement: {
          type: 'basicAny'
        },
        desc: 'è°ƒå’Œäº”è¡Œä¹‹æ°”ï¼Œä½¿å‘¨èº«çµåŠ›å¾ªç¯ä¸æ¯ã€‚éœ€å…·å¤‡ä»»æ„äº”è¡Œçµæ ¹ï¼Œä¿®ç‚¼é€Ÿåº¦ +20%ã€‚'
      },

      /* ======================
       *  ä»™æ³•ç§˜ç± Â· ç¤ºä¾‹
       * ====================== */

      manual_dimensional_slash: {
        id: 'manual_dimensional_slash',
        name: 'ç§˜ç±Â·æ¬¡å…ƒè£‚æ–©',
        type: 'manual',
        rarity: 'mythic',
        source: 'sectAndDrop',
        price: 100000,
        requirement: {
          type: 'rootAnyOf',
          ids: ['space']
        },
        battle: {
          burstDimSlash: true
        },
        desc: 'é™å®šç©ºé—´çµæ ¹è€…ä¿®ç‚¼ã€‚æˆ˜æ–—ä¸­å¯åœ¨æŸä¸€å›åˆæ–©å‡ºæ¬¡å…ƒè£‚ç¼ï¼Œå¯¹æ•Œäººé€ æˆçº¦ 2000% çš„æ™®é€šæ”»å‡»ä¼¤å®³ã€‚'
      },

      /* ======================
       *  æ­¦æŠ€ï¼ˆå¸‚é›†å¯è´­ï¼‰
       * ====================== */

      tech_quick_strike: {
        id: 'tech_quick_strike',
        name: 'æ­¦æŠ€Â·é—ªé£å¿«æ–©',
        type: 'technique',
        rarity: 'uncommon',
        source: 'shopAndDrop',
        price: 2500,
        requirement: null,
        battle: {
          atkMul: 1.12,
          critChance: 0.08
        },
        desc: 'ç®€å•å®ç”¨çš„è¿‘èº«å¿«æ–©æ­¦æŠ€ï¼Œé€‚åˆå¤§å¤šæ•°è¿‘æˆ˜ä¿®å£«ã€‚è¢«åŠ¨æå‡æ”»å‡»ä¸å°‘é‡æš´å‡»ç‡ã€‚'
      },

      tech_iron_body: {
        id: 'tech_iron_body',
        name: 'æ­¦æŠ€Â·é“éª¨æŠ¤èº«è¯€',
        type: 'technique',
        rarity: 'rare',
        source: 'shopAndDrop',
        price: 5000,
        requirement: null,
        battle: {
          hpMul: 1.18,
          damageTakenMul: 0.92
        },
        desc: 'é”¤ç‚¼è‚‰èº«ä¸æ ¹éª¨ï¼Œä½¿ç­‹éª¨å¦‚é’¢é“èˆ¬åšéŸ§ã€‚è¢«åŠ¨æå‡ç”Ÿå‘½ä¸Šé™å¹¶é™ä½æ‰€å—ä¼¤å®³ã€‚'
      }
    };

    /* ========== åŠŸæ³•çŠ¶æ€ ========== */

    let learnedSkillIds = [];
    let equippedMethodId = null;

    function getSkillById(id) {
      return ALL_SKILLS[id] || null;
    }

    function hasSkill(id) {
      return learnedSkillIds.includes(id);
    }

    function addSkill(id) {
      if (!ALL_SKILLS[id]) return false;
      if (!learnedSkillIds.includes(id)) {
        learnedSkillIds.push(id);
        return true;
      }
      return false;
    }

    function getSkillRarityMeta(skill) {
      return SKILL_RARITY_META[skill.rarity] || SKILL_RARITY_META.common;
    }

    function checkSkillRequirement(skill) {
      if (!skill.requirement) return true;
      if (!lingRoots || lingRoots.length === 0) return false;
      const req = skill.requirement;
      if (req.type === 'rootAnyOf') {
        return lingRoots.some(r => req.ids.includes(r.id));
      }
      if (req.type === 'basicAny') {
        return lingRoots.some(r => r.type === 'basic');
      }
      return true;
    }

    function getSkillRequirementText(skill) {
      if (!skill.requirement) return 'æ— ç‰¹æ®Šé™åˆ¶';
      const req = skill.requirement;
      if (req.type === 'rootAnyOf') {
        const names = req.ids.map(id => LING_ROOTS.find(r => r.id === id))
          .filter(Boolean)
          .map(r => r.name);
        return 'é™å®šçµæ ¹ï¼š' + (names.join(' / ') || 'ç‰¹å®šçµæ ¹');
      }
      if (req.type === 'basicAny') {
        return 'éœ€å…·å¤‡ä»»æ„äº”è¡Œçµæ ¹ï¼ˆé‡‘æœ¨æ°´ç«åœŸä¹‹ä¸€ï¼‰';
      }
      return 'ç‰¹æ®Šé™åˆ¶';
    }

    function getEquippedMethodSkill() {
      if (!equippedMethodId) return null;
      return ALL_SKILLS[equippedMethodId] || null;
    }

    function getMethodQiMult() {
      const m = getEquippedMethodSkill();
      if (!m || !m.qiSpeedBonus) return 1;
      return 1 + m.qiSpeedBonus;
    }

    /* ========== å¢ƒç•Œå®šä¹‰ï¼šå‡¡äºº + 11 ä¸ªå¤§å¢ƒç•Œï¼Œæ¯ä¸ªå‰ä¸­åå¤§åœ†æ»¡ ========= */

    const BIG_REALMS = ['å‡¡äºº','è¾Ÿè°·','ç‚¼ä½“','ç»ƒæ°”','ç­‘åŸº','é‡‘ä¸¹','å…ƒå©´','å‡ºçª','å¤§ä¹˜','æ¸¡åŠ«','åŒ–ç¥','ä»™ç­'];
    const REALM_SUFFIXES = ['å‰æœŸ','ä¸­æœŸ','åæœŸ','å¤§åœ†æ»¡'];
    const REALM_NAMES = [];
    const realmThresholds = [];

    REALM_NAMES[0] = 'å‡¡äºº';
    realmThresholds[0] = 0;

    for (let i = 1; i < BIG_REALMS.length; i++) {
      const base = Math.pow(10, i - 1) * 10;
      const factors = [1, 2.5, 5, 9];
      for (let j = 0; j < 4; j++) {
        const stageIndex = (i - 1) * 4 + j + 1;
        REALM_NAMES[stageIndex] = BIG_REALMS[i] + REALM_SUFFIXES[j];
        realmThresholds[stageIndex] = Math.floor(base * factors[j]);
      }
    }

    function getRealmNameFromStage(stage) {
      return REALM_NAMES[stage] || 'å‡¡äºº';
    }

    function getBigRealmIndex(stage) {
      if (stage <= 0) return -1;
      return Math.floor((stage - 1) / 4);
    }

    function isBigRoundStage(stage) {
      return stage > 0 && stage % 4 === 0;
    }

    const REALM_BIG_BONUSES = [
      { power: 1,  physique: 2,  agility: 1,  spirit: 1,  root: 2,  luck: 0 },
      { power: 2,  physique: 3,  agility: 2,  spirit: 1,  root: 2,  luck: 1 },
      { power: 3,  physique: 3,  agility: 2,  spirit: 2,  root: 2,  luck: 1 },
      { power: 4,  physique: 4,  agility: 3,  spirit: 3,  root: 3,  luck: 1 },
      { power: 5,  physique: 5,  agility: 3,  spirit: 4,  root: 3,  luck: 2 },
      { power: 6,  physique: 6,  agility: 4,  spirit: 5,  root: 4,  luck: 2 },
      { power: 7,  physique: 7,  agility: 4,  spirit: 6,  root: 4,  luck: 3 },
      { power: 8,  physique: 8,  agility: 5,  spirit: 7,  root: 5,  luck: 3 },
      { power: 9,  physique: 9,  agility: 5,  spirit: 8,  root: 5,  luck: 4 },
      { power: 10, physique:10, agility: 6,  spirit: 9,  root: 6,  luck: 4 },
      { power: 12, physique:12, agility: 7,  spirit:10, root: 7,  luck: 5 }
    ];

    const REALM_BIG_QI_BONUS = [
      0.02, 0.04, 0.06, 0.09, 0.12, 0.16, 0.20, 0.25, 0.30, 0.40, 0.50
    ];

    function getExpThresholdForBigRealmIndex(idx) {
      if (idx < 0) return 0;
      return 50 * Math.pow(10, idx);
    }

    function getCurrentExpRequirementForBreak(stage, experience) {
      if (!isBigRoundStage(stage)) return 0;
      const idx = getBigRealmIndex(stage);
      return getExpThresholdForBigRealmIndex(idx);
    }

    /* ========== éšæœº flavor å¥å­ ========= */
    const RANDOM_EVENTS = [
      'ä½ åœ¨å½’é€”ä¸­å¶ç„¶æ„Ÿåº”åˆ°è¿œå¤„æœ‰çµè„‰æ³¢åŠ¨ï¼Œä½†ä¿®ä¸ºå°šæµ…ï¼Œåªå¾—è®°åœ¨å¿ƒé‡Œã€‚',
      'ä¸€åªçµå…½ä»èº«æ—æ è¿‡ï¼Œä¼¼ä¹å¯¹ä½ çš„çµæ ¹å¤šçœ‹äº†ä¸€çœ¼ï¼Œéšå³æ¶ˆå¤±åœ¨æ—é—´ã€‚',
      'å¤©ç©ºç‚¸å“ä¸€å£°é—·é›·ï¼Œä½ éšçº¦æ„Ÿåˆ°ä½“å†…çœŸæ°”éšä¹‹éœ‡åŠ¨ã€‚',
      'ä½ è·¯è¿‡ä¸€åº§åºŸå¼ƒçŸ³äº­ï¼ŒçŸ³ç¢‘ä¸Šçš„å¤å­—åœ¨ä½™å…‰ä¸­ä¼¼ä¹é—ªçƒäº†ä¸€ç¬ã€‚',
      'è¿œå¤„æœ‰ä¿®å£«é£å‰‘è€Œè¿‡ï¼Œæº…èµ·çš„çµå…‰åœ¨ä½ çœ¼ä¸­ç•™ä¸‹çŸ­æš‚æ®‹å½±ã€‚',
      'ä¸€é˜µå¾®é£æ‹‚è¿‡ï¼Œä½ ææƒšé—´å¬è§æœ‰äººåœ¨è€³è¾¹ä½å£°å¿µè¯µå¤ç»ã€‚'
    ];
    function getRandomEventText() {
      const idx = Math.floor(Math.random() * RANDOM_EVENTS.length);
      return RANDOM_EVENTS[idx];
    }

    /* ========== å¤šå­˜æ¡£é…ç½® ========== */

    const NUM_SAVE_SLOTS = 3;
    const SAVE_SLOT_KEY_PREFIX = 'xiuxianIdleSave_v10_slot_';
    const ACTIVE_SLOT_KEY = 'xiuxianIdleCurrentSlot_v10';
    let activeSlot = 0;

    function getSlotKey(slot) {
      return SAVE_SLOT_KEY_PREFIX + String(slot);
    }

    function getSlotData(slot) {
      const raw = localStorage.getItem(getSlotKey(slot));
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.error('è¯»å–æ§½ä½å­˜æ¡£å¤±è´¥ï¼š', slot, e);
        return null;
      }
    }

    /* ========== æ ¸å¿ƒçŠ¶æ€ ========== */

    let gameStarted = false;
    let currentPage = 'cultivation';
    let autoBattle = false;

    let qi = 0;
    let qiPerSecond = 0.1;
    let qiPerClick = 1.0;
    let realmStage = 0;

    const baseStats = {
      power: 5, physique: 5, agility: 5,
      spirit: 5, root: 5,    luck: 5
    };
    let stats = { ...baseStats };

    let abilityPoints = 0;
    let spiritStones = 0;
    let experience = 0;

    // æ´åºœ & ä¸¹è¯å“è´¨ / æ•°é‡
    let caveCount = 0;
    let caveQuality = 1;
    let pillLevel = 1;
    let pillQuality = 1;

    // ä¿®ç‚¼åŸºç¡€
    let baseQiPerSecond = 0.1;
    let realmQpsBonus = 0;
    const caveQiPerBase = 0.2;
    let baseQiPerClick = 1.0;

    // ç©å®¶ & çµæ ¹
    let playerName = '';
    let lingRoots = [];

    // å¼€å±€æŠ½çµæ ¹ä¸´æ—¶çŠ¶æ€
    let tempLingRoots = [];
    let rootRollUsed = false;
    let rootRerollLeft = 2;
    let rootWheelRunning = false;
    let rootWheelTimer = null;

    // ç¥Â·/ä»™å·
    let godTitleUnlocked = false;
    let immortalTitle = '';
    let immortalTitleUnlocked = false;

    // æ¸¸å†ï¼ˆæˆ˜æ–—ï¼‰çŠ¶æ€
    let currentBattle = null;
    let battleTimerId = null;
    const BATTLE_TURN_DELAY = 300;
    const MAX_TURNS = 20;
    let currentMapId = 'map_0';

    /* ========== å¸‚é›†å“è´¨æ–‡æœ¬ä¸ä»·æ ¼ ========== */

    const CAVE_QUALITY_NAMES = ['ç®€é™‹æ´åºœ', 'æ™®é€šæ´åºœ', 'ä¸Šå“æ´åºœ', 'æå“æ´åºœ', 'ä»™å“æ´åºœ'];
    const PILL_QUALITY_NAMES = ['å‡¡å“èšæ°”æ•£', 'æ™®é€šèšæ°”æ•£', 'ä¸Šå“èšæ°”æ•£', 'æå“èšæ°”æ•£', 'ä»™å“èšæ°”æ•£'];
    const MAX_CAVE_QUALITY = 5;
    const MAX_PILL_QUALITY = 5;

    const caveBaseStoneCost = 5;
    const pillBaseStoneCost = 4;
    const caveUpgradeBaseCost = 20;
    const pillUpgradeBaseCost = 15;

    // â˜… æ–°å¢ï¼šæ´—é«“ä¸¹ä»·æ ¼
    const washPillCost = 200;

    function getCaveQualityName() {
      const idx = Math.min(caveQuality - 1, CAVE_QUALITY_NAMES.length - 1);
      return CAVE_QUALITY_NAMES[idx];
    }
    function getPillQualityName() {
      const idx = Math.min(pillQuality - 1, PILL_QUALITY_NAMES.length - 1);
      return PILL_QUALITY_NAMES[idx];
    }

    function getCaveBuyCost() {
      return Math.floor(caveBaseStoneCost * Math.pow(1.5, caveCount));
    }
    function getCaveUpgradeCost() {
      return Math.floor(caveUpgradeBaseCost * Math.pow(2, caveQuality - 1));
    }
    function getPillBuyCost() {
      return Math.floor(pillBaseStoneCost * Math.pow(1.4, pillLevel - 1));
    }
    function getPillUpgradeCost() {
      return Math.floor(pillUpgradeBaseCost * Math.pow(2, pillQuality - 1));
    }

    function getCaveQps() {
      return caveCount * caveQiPerBase * (1 + 0.4 * (caveQuality - 1));
    }

    function recalcDerivedStats() {
      const baseQps =
        baseQiPerSecond +
        realmQpsBonus +
        getCaveQps();
      const baseQpc =
        baseQiPerClick +
        (pillLevel - 1) * (1 + 0.4 * (pillQuality - 1));

      const lingMeta = getLingRootTierMeta();
      const methodMult = getMethodQiMult();
      const mult = lingMeta.qiMult * methodMult;

      qiPerSecond = baseQps * mult;
      qiPerClick  = baseQpc * mult;
    }

    /* ========== å­˜æ¡£è¯»å†™é€»è¾‘ ========== */

    function loadFromData(data) {
      qi = typeof data.qi === 'number' ? data.qi : 0;
      baseQiPerSecond =
        typeof data.baseQiPerSecond === 'number' ? data.baseQiPerSecond : 0.1;
      baseQiPerClick =
        typeof data.baseQiPerClick === 'number' ? data.baseQiPerClick : 1.0;
      realmQpsBonus =
        typeof data.realmQpsBonus === 'number' ? data.realmQpsBonus : 0;

      caveCount =
        typeof data.caveCount === 'number' ? data.caveCount : 0;
      caveQuality =
        typeof data.caveQuality === 'number' ? data.caveQuality : 1;
      pillLevel =
        typeof data.pillLevel === 'number' ? data.pillLevel : 1;
      pillQuality =
        typeof data.pillQuality === 'number' ? data.pillQuality : 1;

      realmStage = (typeof data.realmStage === 'number') ? data.realmStage : 0;

      if (data.stats && typeof data.stats.power === 'number') {
        stats = { ...baseStats, ...data.stats };
      } else {
        stats = { ...baseStats };
      }

      abilityPoints = (typeof data.abilityPoints === 'number') ? data.abilityPoints : 0;
      spiritStones  = (typeof data.spiritStones === 'number') ? data.spiritStones : 0;
      experience    = (typeof data.experience === 'number') ? data.experience : 0;

      if (typeof data.playerName === 'string') playerName = data.playerName;
      else playerName = '';

      if (Array.isArray(data.lingRootIds)) {
        lingRoots = data.lingRootIds
          .map(id => LING_ROOTS.find(r => r.id === id))
          .filter(Boolean);
      } else {
        lingRoots = [];
      }

      currentMapId =
        typeof data.currentMapId === 'string' ? data.currentMapId : 'map_0';
      autoBattle = !!data.autoBattle;
      godTitleUnlocked = !!data.godTitleUnlocked;
      immortalTitle =
        typeof data.immortalTitle === 'string' ? data.immortalTitle : '';
      immortalTitleUnlocked = !!data.immortalTitleUnlocked;

      if (Array.isArray(data.learnedSkillIds)) {
        learnedSkillIds = data.learnedSkillIds.filter(id => !!ALL_SKILLS[id]);
      } else {
        learnedSkillIds = [];
      }
      if (typeof data.equippedMethodId === 'string' && ALL_SKILLS[data.equippedMethodId]) {
        equippedMethodId = data.equippedMethodId;
      } else {
        equippedMethodId = null;
      }

      recalcDerivedStats();
    }

    function saveGameToSlot(slot) {
      if (slot < 0 || slot >= NUM_SAVE_SLOTS) return;
      if (!gameStarted) return;
      const data = {
        qi,
        baseQiPerSecond,
        baseQiPerClick,
        realmQpsBonus,
        caveCount,
        caveQuality,
        pillLevel,
        pillQuality,
        realmStage,
        stats,
        abilityPoints,
        spiritStones,
        experience,
        playerName,
        lingRootIds: lingRoots.map(r => r.id),
        currentMapId,
        autoBattle,
        godTitleUnlocked,
        immortalTitle,
        immortalTitleUnlocked,
        learnedSkillIds,
        equippedMethodId,
        lastSaveTime: Date.now()
      };
      try {
        localStorage.setItem(getSlotKey(slot), JSON.stringify(data));
      } catch (e) {
        console.error('å­˜æ¡£å¤±è´¥ï¼š', e);
      }
    }

    function saveGame() {
      if (!gameStarted) return;
      saveGameToSlot(activeSlot);
      localStorage.setItem(ACTIVE_SLOT_KEY, String(activeSlot));
    }

    function loadGameFromSlot(slot) {
      const raw = localStorage.getItem(getSlotKey(slot));
      if (!raw) return false;
      try {
        const data = JSON.parse(raw);
        loadFromData(data);
        activeSlot = slot;
        localStorage.setItem(ACTIVE_SLOT_KEY, String(activeSlot));
        gameStarted = !!(playerName && playerName.trim() && lingRoots.length > 0);
        return true;
      } catch (e) {
        console.error('è¯»å–å­˜æ¡£å¤±è´¥ï¼š', e);
        return false;
      }
    }

    function loadGameAtStartup() {
      const storedSlot = localStorage.getItem(ACTIVE_SLOT_KEY);
      let slot = 0;
      if (storedSlot !== null) {
        const n = parseInt(storedSlot, 10);
        if (!isNaN(n) && n >= 0 && n < NUM_SAVE_SLOTS) slot = n;
      }
      activeSlot = slot;
      const ok = loadGameFromSlot(activeSlot);
      if (!ok) {
        const legacy = localStorage.getItem('xiuxianIdleSave_v9');
        if (legacy) {
          try {
            const data = JSON.parse(legacy);
            loadFromData(data);
            activeSlot = 0;
            gameStarted = !!(playerName && playerName.trim() && lingRoots.length > 0);
            saveGameToSlot(0);
            localStorage.setItem(ACTIVE_SLOT_KEY, '0');
            localStorage.removeItem('xiuxianIdleSave_v9');
          } catch (e) {
            console.error('è¿ç§»æ—§å­˜æ¡£å¤±è´¥ï¼š', e);
          }
        }
      }
    }

    /* ========== DOM å¼•ç”¨ ========== */

    const qiSpan = document.getElementById('qi');
    const qpsSpan = document.getElementById('qps');
    const qpcSpan = document.getElementById('qpc');
    const realmSpan = document.getElementById('realm');

    const expMainSpan = document.getElementById('expMainSpan');
    const expReqSpan = document.getElementById('expReqSpan');
    const breakthroughBtn = document.getElementById('breakthroughBtn');

    const statPowerSpan = document.getElementById('statPower');
    const statPhysiqueSpan = document.getElementById('statPhysique');
    const statAgilitySpan = document.getElementById('statAgility');
    const statSpiritSpan = document.getElementById('statSpirit');
    const statRootSpan = document.getElementById('statRoot');
    const statLuckSpan = document.getElementById('statLuck');

    const abilityPointsSpan = document.getElementById('abilityPoints');
    const spiritStonesSpan = document.getElementById('spiritStonesSpan');
    const experienceSpan = document.getElementById('experienceSpan');
    const experienceBuffSpan = document.getElementById('experienceBuffSpan');

    const shopSpiritStonesSpan = document.getElementById('shopSpiritStones');

    const cultivateBtn = document.getElementById('cultivateBtn');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const plusButtons = document.querySelectorAll('.btn-plus');

    const startScreen = document.getElementById('startScreen');
    const playerNameInput = document.getElementById('playerNameInput');
    const startGameBtn = document.getElementById('startGameBtn');
    const playerNameSpan = document.getElementById('playerName');
    const lingRootNameSpan = document.getElementById('lingRootName');
    const lingRootTableDiv = document.getElementById('lingRootTable');
    const lingRootBonusText = document.getElementById('lingRootBonusText');

    const rootDrawPanel = document.getElementById('rootDrawPanel');
    const rootPlayerNameSpan = document.getElementById('rootPlayerName');
    const rootWheel = document.getElementById('rootWheel');
    const rootWheelName = document.getElementById('rootWheelName');
    const rootResultNameSpan = document.getElementById('rootResultName');
    const rootResultTierSpan = document.getElementById('rootResultTier');
    const rootResultDescDiv = document.getElementById('rootResultDesc');
    const btnRootRoll = document.getElementById('btnRootRoll');
    const btnRootReroll = document.getElementById('btnRootReroll');
    const btnRootConfirm = document.getElementById('btnRootConfirm');
    const rootRerollLeftSpan = document.getElementById('rootRerollLeft');

    const pageCultivation = document.getElementById('pageCultivation');
    const pageBattle = document.getElementById('pageBattle');
    const pageShop = document.getElementById('pageShop');
    const pageSkills = document.getElementById('pageSkills');
    const pageSect = document.getElementById('pageSect');
    const navItems = document.querySelectorAll('.nav-item');

    const caveCostSpan = document.getElementById('caveCost');
    const caveCountSpan = document.getElementById('caveCount');
    const caveQualitySpan = document.getElementById('caveQualitySpan');
    const caveUpgradeCostSpan = document.getElementById('caveUpgradeCost');
    const caveQpsSpan = document.getElementById('caveQpsSpan');

    const pillCostSpan = document.getElementById('pillCost');
    const pillLevelSpan = document.getElementById('pillLevel');
    const pillQualitySpan = document.getElementById('pillQualitySpan');
    const pillUpgradeCostSpan = document.getElementById('pillUpgradeCost');

    const buyCaveBtn = document.getElementById('buyCaveBtn');
    const upgradeCaveBtn = document.getElementById('upgradeCaveBtn');
    const buyPillBtn = document.getElementById('buyPillBtn');
    const upgradePillBtn = document.getElementById('upgradePillBtn');

    const shopSkillList = document.getElementById('shopSkillList');

    // â˜… æ–°å¢ï¼šæ´—é«“ä¸¹æŒ‰é’®
    const buyWashRootPillBtn = document.getElementById('buyWashRootPillBtn');

    // æ¸¸å†
    const playerBattleStatsDiv = document.getElementById('playerBattleStats');
    const mapSelect = document.getElementById('mapSelect');
    const startBattleBtn = document.getElementById('startBattleBtn');
    const battleResultDiv = document.getElementById('battleResult');
    const battleLogDiv = document.getElementById('battleLog');
    const autoBattleToggle = document.getElementById('autoBattleToggle');

    const battleResultOverlay = document.getElementById('battleResultOverlay');
    const resultTitle = document.getElementById('resultTitle');
    const resultSummary = document.getElementById('resultSummary');
    const resultDrops = document.getElementById('resultDrops');
    const resultExtra = document.getElementById('resultExtra');
    const randomEventDiv = document.getElementById('randomEvent');
    const closeResultBtn = document.getElementById('closeResultBtn');

    // åŠŸæ³•é¡µ DOM
    const activeMethodInfo = document.getElementById('activeMethodInfo');
    const knownSkillsList = document.getElementById('knownSkillsList');
    const sectOfferList = document.getElementById('sectOfferList');

    // å­˜æ¡£ UI DOM
    const activeSlotSpan = document.getElementById('activeSlotSpan');
    const saveSlotList = document.getElementById('saveSlotList');

    /* ========== çµæ ¹ UI ========== */

    function updateLingRootUI() {
      lingRootNameSpan.textContent = getLingRootDisplayName();
      applyLingRootColor(lingRootNameSpan, lingRoots);

      const meta = getLingRootTierMeta();
      const qiBonus      = ((meta.qiMult - 1) * 100).toFixed(0);
      const abilityBonus = ((meta.abilityMult - 1) * 100).toFixed(0);
      const eventBonus   = ((meta.eventMult - 1) * 100).toFixed(0);

      function fmt(v) {
        const n = Number(v);
        if (n === 0) return '+0%';
        return (n > 0 ? '+' : '') + n + '%';
      }
      lingRootBonusText.textContent =
        `ä¿®ç‚¼é€Ÿåº¦ ${fmt(qiBonus)} Â· èƒ½åŠ›ç‚¹ ${fmt(abilityBonus)} Â· å¥‡é‡æƒé‡ ${fmt(eventBonus)}`;

      lingRootTableDiv.innerHTML = '';
      if (!lingRoots || lingRoots.length === 0) {
        lingRootTableDiv.textContent = 'å°šæœªè§‰é†’çµæ ¹ã€‚';
        return;
      }

      if (lingRoots.length === 2 && lingRoots.every(r => r.type === 'basic')) {
        const [r1, r2] = lingRoots;
        const rel = getDualBasicRelation(lingRoots);
        const cfg1 = LING_ROOTS_CONFIG && LING_ROOTS_CONFIG[r1.id];
        const cfg2 = LING_ROOTS_CONFIG && LING_ROOTS_CONFIG[r2.id];

        const row1 = document.createElement('div');
        row1.className = 'ling-root-row';
        const comboLabel = rel && rel.comboName ? `${rel.label} Â· ${rel.comboName}` : rel.label;
        row1.innerHTML = `<span>${r1.short}${r2.short}åŒçµæ ¹</span><span>å±‚çº§ï¼š${comboLabel}</span>`;
        lingRootTableDiv.appendChild(row1);

        const row2 = document.createElement('div');
        row2.className = 'ling-root-row';
        row2.innerHTML =
          `<span>èƒ½åŠ›å€¾å‘ï¼š</span><span>${r1.name} ä¸ ${r2.name} å¹¶å­˜ã€‚${rel.descExtra || ''}</span>`;
        lingRootTableDiv.appendChild(row2);

        if (cfg1 || cfg2) {
          const row3 = document.createElement('div');
          row3.className = 'ling-root-row';
          const parts = [];
          if (cfg1) parts.push(`${cfg1.name}ï¼š${cfg1.foundationRole}`);
          if (cfg2) parts.push(`${cfg2.name}ï¼š${cfg2.foundationRole}`);
          row3.innerHTML = `<span>åŸºç¡€å®šä½ï¼š</span><span>${parts.join('ï¼›')}</span>`;
          lingRootTableDiv.appendChild(row3);
        }
      } else {
        lingRoots.forEach(r => {
          const row1 = document.createElement('div');
          row1.className = 'ling-root-row';
          row1.innerHTML =
            `<span>${r.name}</span><span>å±‚çº§ï¼š${r.tierGroup} Â· ç±»å‹ï¼š${r.type === 'special' ? 'ç¨€æœ‰' : 'äº”è¡Œ'}</span>`;
          lingRootTableDiv.appendChild(row1);

          const row2 = document.createElement('div');
          row2.className = 'ling-root-row';
          const cfg = LING_ROOTS_CONFIG && LING_ROOTS_CONFIG[r.id];
          if (cfg) {
            const detailText =
              `${cfg.foundationRole}ã€‚æˆ˜æ–—ï¼š${cfg.battle}ï¼›ç”Ÿäº§/ç³»ç»Ÿï¼š${cfg.production}`;
            row2.innerHTML = `<span>èƒ½åŠ›å€¾å‘ï¼š</span><span>${detailText}</span>`;
          } else {
            row2.innerHTML = `<span>èƒ½åŠ›å€¾å‘ï¼š</span><span>${r.desc}</span>`;
          }
          lingRootTableDiv.appendChild(row2);
        });
      }

      const extra = document.createElement('div');
      extra.className = 'ling-root-row';
      const meta2 = getLingRootTierMeta();
      const qi2 = ((meta2.qiMult - 1) * 100).toFixed(0);
      const ab2 = ((meta2.abilityMult - 1) * 100).toFixed(0);
      const ev2 = ((meta2.eventMult - 1) * 100).toFixed(0);
      extra.innerHTML =
        `<span>ç³»ç»ŸåŠ æˆï¼š</span><span>${meta2.label}ï¼ˆä¿®ç‚¼é€Ÿåº¦ ${qi2}% Â· èƒ½åŠ›ç‚¹ ${ab2}% Â· å¥‡é‡æƒé‡ ${ev2}%ï¼‰</span>`;
      lingRootTableDiv.appendChild(extra);
    }

    /* ========== åŠŸæ³•é¡µ / å®—é—¨ / å•†åº—æŠ€èƒ½ UI ========== */

    function updateSkillsUI() {
      if (!activeMethodInfo || !knownSkillsList) return;

      if (!gameStarted) {
        activeMethodInfo.textContent = 'å°šæœªå¼€å§‹ä¿®ç‚¼ã€‚';
        knownSkillsList.textContent = 'æš‚æ— ä»»ä½•åŠŸæ³•æˆ–æ­¦æŠ€ã€‚';
        return;
      }

      const method = getEquippedMethodSkill();
      if (!method) {
        activeMethodInfo.textContent =
          'å½“å‰æœªä¸»ä¿®ä»»ä½•å¿ƒæ³•ã€‚å¯å‰å¾€ã€Œå®—é—¨ã€å­¦ä¹ ä¸çµæ ¹å¥‘åˆçš„åŠŸæ³•ï¼Œä»¥è¿›ä¸€æ­¥æå‡ä¿®ç‚¼é€Ÿåº¦ã€‚';
      } else {
        const rar = getSkillRarityMeta(method);
        const bonusPercent = method.qiSpeedBonus ? Math.round(method.qiSpeedBonus * 100) : 0;
        activeMethodInfo.innerHTML =
          `å½“å‰ä¸»ä¿®ï¼š<span class="skill-name ${rar.className}">${method.name}ï¼ˆ${rar.label}Â·å¿ƒæ³•ï¼‰</span> Â· ` +
          `æ•ˆæœï¼šä¿®ç‚¼é€Ÿåº¦ +${bonusPercent}%ã€‚`;
      }

      if (!learnedSkillIds.length) {
        knownSkillsList.textContent = 'ä½ å°šæœªæŒæ¡ä»»ä½•åŠŸæ³•æˆ–æ­¦æŠ€ã€‚';
        return;
      }

      knownSkillsList.innerHTML = '';
      learnedSkillIds.forEach(id => {
        const skill = getSkillById(id);
        if (!skill) return;
        const rar = getSkillRarityMeta(skill);
        const wrapper = document.createElement('div');
        wrapper.className = 'skill-item';

        const left = document.createElement('div');
        left.className = 'skill-left';
        const typeLabel =
          skill.type === 'method' ? 'å¿ƒæ³•'
          : skill.type === 'manual' ? 'ç§˜ç±'
          : 'æ­¦æŠ€';
        left.innerHTML =
          `<div class="skill-name ${rar.className}">${skill.name}ï¼ˆ${rar.label}Â·${typeLabel}ï¼‰</div>` +
          `<div>${skill.desc || ''}</div>`;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.alignItems = 'flex-end';
        right.style.gap = '4px';

        const reqText = getSkillRequirementText(skill);
        const spanReq = document.createElement('div');
        spanReq.style.fontSize = '11px';
        spanReq.style.color = '#9aa0c6';
        spanReq.textContent = reqText;
        right.appendChild(spanReq);

        if (skill.type === 'method') {
          const btn = document.createElement('button');
          btn.className = 'btn-small';
          if (equippedMethodId === skill.id) {
            btn.textContent = 'å·²ä¸»ä¿®';
            btn.disabled = true;
          } else {
            btn.textContent = 'è®¾ä¸ºä¸»ä¿®';
            btn.addEventListener('click', () => {
              equippedMethodId = skill.id;
              recalcDerivedStats();
              updateUI();
              saveGame();
            });
          }
          right.appendChild(btn);
        }

        wrapper.appendChild(left);
        wrapper.appendChild(right);
        knownSkillsList.appendChild(wrapper);
      });
    }

    function refreshSectOfferingsUI() {
      if (!sectOfferList) return;
      sectOfferList.innerHTML = '';
      if (!gameStarted) {
        sectOfferList.textContent = 'è¯·å…ˆè¸å…¥ä¿®ä»™å¹¶è§‰é†’çµæ ¹ã€‚';
        return;
      }

      const offerSkills = Object.values(ALL_SKILLS).filter(skill =>
        skill.source === 'sect' || skill.source === 'sectAndDrop'
      );

      if (!offerSkills.length) {
        sectOfferList.textContent = 'å®—é—¨æš‚æœªå¼€æ”¾ä¼ æ‰¿ã€‚';
        return;
      }

      offerSkills.forEach(skill => {
        const rar = getSkillRarityMeta(skill);
        const wrapper = document.createElement('div');
        wrapper.className = 'skill-item';

        const left = document.createElement('div');
        left.className = 'skill-left';
        const typeLabel =
          skill.type === 'method' ? 'å¿ƒæ³•'
          : skill.type === 'manual' ? 'ç§˜ç±'
          : 'æ­¦æŠ€';
        left.innerHTML =
          `<div class="skill-name ${rar.className}">${skill.name}ï¼ˆ${rar.label}Â·${typeLabel}ï¼‰</div>` +
          `<div>${skill.desc || ''}</div>` +
          `<div style="font-size:11px;color:#b6c1ff;">ä»·æ ¼ï¼š${skill.price} çµçŸ³</div>` +
          `<div style="font-size:11px;color:#9aa0c6;">${getSkillRequirementText(skill)}</div>`;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.alignItems = 'flex-end';
        right.style.gap = '4px';

        const btn = document.createElement('button');
        btn.className = 'btn-small';

        const alreadyLearned = hasSkill(skill.id);
        const reqOK = checkSkillRequirement(skill);
        if (alreadyLearned) {
          btn.textContent = 'å·²æŒæ¡';
          btn.disabled = true;
        } else if (!reqOK) {
          btn.textContent = 'çµæ ¹ä¸ç¬¦';
          btn.disabled = true;
        } else {
          btn.textContent = 'å­¦ä¹ ';
          btn.disabled = spiritStones < skill.price;
          btn.addEventListener('click', () => {
            if (spiritStones < skill.price) {
              alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•å­¦ä¹ æ­¤åŠŸæ³•ã€‚');
              return;
            }
            if (!checkSkillRequirement(skill)) {
              alert('ä½ çš„çµæ ¹ä¸æ­¤åŠŸæ³•ä¸ç¬¦ï¼Œæš‚æ— æ³•ä¿®ç‚¼ã€‚');
              return;
            }
            spiritStones -= skill.price;
            addSkill(skill.id);
            if (skill.type === 'method' && !equippedMethodId) {
              equippedMethodId = skill.id;
            }
            recalcDerivedStats();
            updateUI();
            refreshSectOfferingsUI();
            saveGame();
          });
        }
        right.appendChild(btn);

        wrapper.appendChild(left);
        wrapper.appendChild(right);
        sectOfferList.appendChild(wrapper);
      });
    }

    function refreshShopSkillsUI() {
      if (!shopSkillList) return;
      shopSkillList.innerHTML = '';
      if (!gameStarted) {
        shopSkillList.textContent = 'è¯·å…ˆå¼€å§‹ä¿®ç‚¼ã€‚';
        return;
      }

      const skills = Object.values(ALL_SKILLS).filter(skill =>
        skill.source === 'shop' || skill.source === 'shopAndDrop'
      );
      if (!skills.length) {
        shopSkillList.textContent = 'å¸‚é›†ä¸­æš‚æœªæœ‰å¯è´­ä¹°çš„æ­¦æŠ€å·è½´ã€‚';
        return;
      }

      skills.forEach(skill => {
        const rar = getSkillRarityMeta(skill);
        const wrapper = document.createElement('div');
        wrapper.className = 'skill-item';

        const left = document.createElement('div');
        left.className = 'skill-left';
        left.innerHTML =
          `<div class="skill-name ${rar.className}">${skill.name}ï¼ˆ${rar.label}Â·æ­¦æŠ€ï¼‰</div>` +
          `<div>${skill.desc || ''}</div>` +
          `<div style="font-size:11px;color:#b6c1ff;">ä»·æ ¼ï¼š${skill.price} çµçŸ³</div>`;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.alignItems = 'flex-end';
        right.style.gap = '4px';

        const btn = document.createElement('button');
        btn.className = 'btn-small';

        if (hasSkill(skill.id)) {
          btn.textContent = 'å·²æŒæ¡';
          btn.disabled = true;
        } else {
          btn.textContent = 'è´­ä¹°';
          btn.disabled = spiritStones < skill.price;
          btn.addEventListener('click', () => {
            if (spiritStones < skill.price) {
              alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æ­¤æ­¦æŠ€å·è½´ã€‚');
              return;
            }
            spiritStones -= skill.price;
            addSkill(skill.id);
            recalcDerivedStats();
            updateUI();
            refreshShopSkillsUI();
            saveGame();
          });
        }
        right.appendChild(btn);

        wrapper.appendChild(left);
        wrapper.appendChild(right);
        shopSkillList.appendChild(wrapper);
      });
    }

    /* ========== å­˜æ¡£ç®¡ç† UI ========== */

    function updateSaveSlotUI() {
      if (!activeSlotSpan || !saveSlotList) return;
      activeSlotSpan.textContent = (activeSlot + 1) + 'å·';

      saveSlotList.innerHTML = '';
      for (let i = 0; i < NUM_SAVE_SLOTS; i++) {
        const data = getSlotData(i);
        const row = document.createElement('div');
        row.className = 'upgrade';

        const infoDiv = document.createElement('div');
        infoDiv.className = 'upgrade-info';

        if (data && data.playerName) {
          const name = data.playerName || 'æ— åæ•£ä¿®';
          const realmName = getRealmNameFromStage(
            typeof data.realmStage === 'number' ? data.realmStage : 0
          );
          const timeStr = data.lastSaveTime
            ? new Date(data.lastSaveTime).toLocaleString()
            : 'æœªçŸ¥æ—¶é—´';
          infoDiv.innerHTML =
            `æ§½ä½ ${i + 1}ï¼š<strong>${name}</strong>ï¼ˆ${realmName}ï¼‰<br>` +
            `<span style="font-size:11px;color:#9aa0c6;">ä¸Šæ¬¡ä¿å­˜ï¼š${timeStr}</span>`;
        } else {
          infoDiv.innerHTML =
            `æ§½ä½ ${i + 1}ï¼š<span style="color:#9aa0c6;">ç©ºå­˜æ¡£</span>`;
        }

        row.appendChild(infoDiv);

        const btnWrap = document.createElement('div');
        btnWrap.style.display = 'flex';
        btnWrap.style.flexDirection = 'column';
        btnWrap.style.gap = '4px';

        const loadBtn = document.createElement('button');
        loadBtn.className = 'btn-small';
        loadBtn.textContent = 'è¯»å–';
        loadBtn.disabled = !data;
        loadBtn.addEventListener('click', () => {
          if (!data) return;
          if (currentBattle || battleTimerId) {
            alert('æˆ˜æ–—ä¸­æ— æ³•åˆ‡æ¢å­˜æ¡£ï¼Œè¯·å…ˆç»“æŸå½“å‰æ¸¸å†ã€‚');
            return;
          }
          const ok = loadGameFromSlot(i);
          if (ok) {
            startScreen.style.display = gameStarted ? 'none' : 'flex';
            rootDrawPanel.style.display = gameStarted ? 'none' : 'none';
            recalcDerivedStats();
            updateUI();
          }
        });

        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn-small';
        saveBtn.textContent = (i === activeSlot ? 'ä¿å­˜' : 'è¦†ç›–');
        saveBtn.addEventListener('click', () => {
          if (!gameStarted) {
            alert('å½“å‰æ²¡æœ‰æ­£åœ¨ä¿®ç‚¼çš„è§’è‰²ï¼Œæ— æ³•ä¿å­˜ã€‚');
            return;
          }
          activeSlot = i;
          saveGame();
          updateSaveSlotUI();
        });

        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn-small';
        clearBtn.textContent = 'æ¸…ç©º';
        clearBtn.addEventListener('click', () => {
          if (!confirm(`ç¡®å®šæ¸…ç©º ${i + 1} å·å­˜æ¡£å—ï¼Ÿ`)) return;
          localStorage.removeItem(getSlotKey(i));
          updateSaveSlotUI();
        });

        const selectBtn = document.createElement('button');
        selectBtn.className = 'btn-small';
        selectBtn.textContent = 'é€‰æ‹©';
        selectBtn.addEventListener('click', () => {
          if (currentBattle || battleTimerId) {
            alert('æˆ˜æ–—ä¸­æ— æ³•åˆ‡æ¢å­˜æ¡£æ§½ï¼Œè¯·å…ˆç»“æŸå½“å‰æ¸¸å†ã€‚');
            return;
          }
          if (i === activeSlot) {
            alert('è¯¥æ§½ä½å·²ç»æ˜¯å½“å‰å­˜æ¡£æ§½ã€‚');
            return;
          }

          if (gameStarted) {
            const wantSave = confirm(
              'åœ¨åˆ‡æ¢åˆ°æ–°çš„å­˜æ¡£æ§½å‰ï¼Œè¦å…ˆå°†å½“å‰è¿›åº¦ä¿å­˜åˆ°å½“å‰æ§½ä½å—ï¼Ÿ\n\nâ€œç¡®å®šâ€=ä¿å­˜ååˆ‡æ¢ï¼Œâ€œå–æ¶ˆâ€=ç›´æ¥åˆ‡æ¢ã€‚'
            );
            if (wantSave) {
              saveGame();
            }
          }

          const slotData = getSlotData(i);
          activeSlot = i;
          localStorage.setItem(ACTIVE_SLOT_KEY, String(activeSlot));

          if (slotData) {
            loadGameFromSlot(i);
            startScreen.style.display = gameStarted ? 'none' : 'flex';
            rootDrawPanel.style.display = 'none';
            recalcDerivedStats();
            updateUI();
          } else {
            resetGame();
            startScreen.style.display = 'flex';
            rootDrawPanel.style.display = 'none';
            updateSaveSlotUI();
            updateUI();
          }
        });

        btnWrap.appendChild(loadBtn);
        btnWrap.appendChild(saveBtn);
        btnWrap.appendChild(clearBtn);
        btnWrap.appendChild(selectBtn);

        row.appendChild(btnWrap);
        saveSlotList.appendChild(row);
      }
    }

    /* ========== å¢ƒç•ŒåŠ æˆ ========= */

    function applyStageBonus(stage) {
      if (stage <= 0) return;
      const bigIdx = getBigRealmIndex(stage);
      const incBase = 1 + Math.floor(bigIdx / 2);

      stats.power    += incBase;
      stats.physique += incBase + 1;
      stats.agility  += incBase;
      stats.spirit   += incBase;
      stats.root     += incBase + 1;
      stats.luck     += Math.max(1, Math.floor(incBase / 2));
    }

    function applyRealmBonus(stage) {
      if (stage <= 0) return;
      const idx = getBigRealmIndex(stage);
      if (idx < 0 || idx >= REALM_BIG_BONUSES.length) return;
      const bonus = REALM_BIG_BONUSES[idx];
      stats.power    += bonus.power;
      stats.physique += bonus.physique;
      stats.agility  += bonus.agility;
      stats.spirit   += bonus.spirit;
      stats.root     += bonus.root;
      stats.luck     += bonus.luck;
      realmQpsBonus  += REALM_BIG_QI_BONUS[idx] || 0;
      recalcDerivedStats();
    }

    /* ========== è‡ªåŠ¨çªç ´ & æ‰‹åŠ¨çªç ´ ========= */

    function checkBreakthrough() {
      let upgraded = false;
      while (realmStage < realmThresholds.length - 1) {
        const nextStage = realmStage + 1;
        if (qi < realmThresholds[nextStage]) break;
        if (isBigRoundStage(realmStage)) break;
        realmStage = nextStage;
        applyStageBonus(realmStage);
        if (isBigRoundStage(realmStage)) {
          applyRealmBonus(realmStage);
        }
        upgraded = true;
      }
      if (upgraded) recalcDerivedStats();
    }

    function canManualBreakthrough() {
      if (!gameStarted) return false;
      if (!isBigRoundStage(realmStage)) return false;
      if (realmStage >= realmThresholds.length - 1) return false;

      const expReq = getCurrentExpRequirementForBreak(realmStage, experience);
      if (experience < expReq) return false;

      const nextStage = realmStage + 1;
      if (qi < realmThresholds[nextStage]) return false;

      return true;
    }

    function doManualBreakthrough() {
      if (!canManualBreakthrough()) return;

      const bigIdxCurrent = getBigRealmIndex(realmStage);
      if (bigIdxCurrent >= 3) {
        const failChance = (bigIdxCurrent - 2) / 100;
        if (Math.random() < failChance) {
          const lost = Math.floor(qi * 0.1);
          qi = Math.max(0, qi - lost);
          alert(`çªç ´å¤±è´¥ï¼çœŸæ°”éœ‡è¡ï¼ŒæŸå¤± ${lost} ç‚¹çœŸæ°”ã€‚å¯è°ƒæ•´å¿ƒå¢ƒåå†å°è¯•ã€‚`);
          updateUI();
          return;
        }
      }

      const oldName = getRealmNameFromStage(realmStage);
      realmStage = realmStage + 1;
      applyStageBonus(realmStage);
      if (isBigRoundStage(realmStage)) {
        applyRealmBonus(realmStage);
      }
      checkBreakthrough();
      recalcDerivedStats();
      const newName = getRealmNameFromStage(realmStage);
      updateUI();
      alert(`ä½ ä»ã€Œ${oldName}ã€çªç ´åˆ°äº†ã€Œ${newName}ã€ï¼`);
    }

    /* ========== èƒ½åŠ›ç‚¹æ‰è½ ========= */

    function rollAbilityPoint(source) {
      const base = (source === 'auto') ? 0.004 : 0.018;
      const meta = getLingRootTierMeta();
      const lingMult = meta.abilityMult;
      const luckDiff = stats.luck - baseStats.luck;
      const luckMult = 1 + luckDiff * 0.03;
      let chance = base * lingMult * luckMult;
      if (chance > 0.8) chance = 0.8;
      if (Math.random() < chance) {
        abilityPoints++;
      }
    }

    /* ========== æ¸¸å†å±æ€§ ========= */

    function getPlayerBattleStats() {
      const expBuff = 1 + Math.min(experience * 0.002, 0.5);
      const maxHp = 90 + stats.physique * 9 + stats.root * 6;
      const mpMax = 50 + stats.spirit * 5;
      const atk = (10 + stats.power * 2) * expBuff;
      let dodge = 0.05 + stats.agility * 0.006;
      if (dodge > 0.45) dodge = 0.45;
      const spd = 100 + stats.agility * 2;

      return {
        maxHp: Math.floor(maxHp),
        hp: Math.floor(maxHp),
        mpMax: Math.floor(mpMax),
        mp: Math.floor(mpMax),
        atk: Math.floor(atk),
        dodge,
        spd,
        phys: stats.physique,
        root: stats.root
      };
    }

    function updateBattleStatsUI() {
      if (!playerBattleStatsDiv) return;
      if (!gameStarted) {
        playerBattleStatsDiv.textContent = 'å°šæœªè¸å…¥ä¿®è¡Œï¼Œå±æ€§æœªçŸ¥ã€‚';
        return;
      }
      const base = getPlayerBattleStats();
      playerBattleStatsDiv.textContent =
        `ä½ çš„å±æ€§ï¼šç”Ÿå‘½ ${base.maxHp} Â· æ”»å‡» ${base.atk} Â· è“é‡ ${base.mpMax} Â· ` +
        `é—ªé¿ ${(base.dodge * 100).toFixed(1)}% Â· é€Ÿåº¦ ${base.spd}`;
    }

    function getSkillBattleEffects() {
      const eff = {
        atkMul: 1,
        hpMul: 1,
        speedMul: 1,
        dodgeBonus: 0,
        damageTakenMul: 1,
        enemySpeedMul: 1,
        lifeSteal: 0,
        regenPerTurn: 0,
        critChance: 0,
        critMul: 1.5,
        extraTurnChance: 0,
        burstDimSlash: false
      };

      learnedSkillIds.forEach(id => {
        const s = getSkillById(id);
        if (!s || !s.battle) return;
        const b = s.battle;
        if (b.atkMul) eff.atkMul *= b.atkMul;
        if (b.hpMul) eff.hpMul *= b.hpMul;
        if (b.speedMul) eff.speedMul *= b.speedMul;
        if (b.dodgeBonus) eff.dodgeBonus += b.dodgeBonus;
        if (b.damageTakenMul) eff.damageTakenMul *= b.damageTakenMul;
        if (b.enemySpeedMul) eff.enemySpeedMul *= b.enemySpeedMul;
        if (b.lifeSteal) eff.lifeSteal += b.lifeSteal;
        if (b.regenPerTurn) eff.regenPerTurn += b.regenPerTurn;
        if (b.critChance) eff.critChance += b.critChance;
        if (b.critMul) eff.critMul = Math.max(eff.critMul, b.critMul);
        if (b.extraTurnChance) eff.extraTurnChance += b.extraTurnChance;
        if (b.burstDimSlash) eff.burstDimSlash = true;
      });

      if (eff.critChance > 0.5) eff.critChance = 0.5;
      if (eff.dodgeBonus > 0.3) eff.dodgeBonus = 0.3;
      return eff;
    }

    function getLingRootBattleEffects() {
      const baseEff = {
        atkMul: 1,
        hpMul: 1,
        speedMul: 1,
        dodgeBonus: 0,
        damageTakenMul: 1,
        enemySpeedMul: 1,
        lifeSteal: 0,
        regenPerTurn: 0,
        critChance: 0,
        critMul: 1.5,
        extraTurnChance: 0,
        burstDimSlash: false
      };
      const skillEff = getSkillBattleEffects();
      baseEff.atkMul *= skillEff.atkMul;
      baseEff.hpMul *= skillEff.hpMul;
      baseEff.speedMul *= skillEff.speedMul;
      baseEff.dodgeBonus += skillEff.dodgeBonus;
      baseEff.damageTakenMul *= skillEff.damageTakenMul;
      baseEff.enemySpeedMul *= skillEff.enemySpeedMul;
      baseEff.lifeSteal += skillEff.lifeSteal;
      baseEff.regenPerTurn += skillEff.regenPerTurn;
      baseEff.critChance += skillEff.critChance;
      baseEff.critMul = Math.max(baseEff.critMul, skillEff.critMul);
      baseEff.extraTurnChance += skillEff.extraTurnChance;
      baseEff.burstDimSlash = skillEff.burstDimSlash;
      return baseEff;
    }

    /* ========== ä¼¤å®³å…¬å¼ ========= */

    function calcDamage(attackerAtk, defenderPhysique, defenderRoot) {
      const defScore = defenderPhysique * 0.6 + defenderRoot * 0.4;
      let mitigate = 1 / (1 + defScore * 0.018);
      if (mitigate < 0.35) mitigate = 0.35;
      if (mitigate > 1) mitigate = 1;
      const variance = 0.9 + Math.random() * 0.2;
      const raw = attackerAtk * variance;
      return Math.max(1, Math.floor(raw * mitigate));
    }

    /* ========== åœ°å›¾ ========= */

    let MAPS = [];

    function generateMaps() {
      MAPS = [];
      for (let s = 0; s < REALM_NAMES.length; s++) {
        const stageName = REALM_NAMES[s];
        let rewardMult = 0.6 + s * 0.12;
        if (rewardMult > 6) rewardMult = 6;
        MAPS.push({
          id: 'map_' + s,
          name: `${stageName} Â· æ¸¸å†ä¹‹åœ°`,
          enemyStage: s,
          rewardMult
        });
      }
    }

    function initMaps() {
      mapSelect.innerHTML = '';
      MAPS.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        mapSelect.appendChild(opt);
      });
      mapSelect.value = currentMapId;
    }

    function getCurrentMap() {
      return MAPS.find(m => m.id === currentMapId) || MAPS[0];
    }

    /* ========== æ•Œäººç”Ÿæˆ ========= */

    function generateRandomEnemy(targetStage) {
      const enemyStage = (typeof targetStage === 'number') ? targetStage : realmStage;
      const stageDiff = enemyStage - realmStage;
      const stageFactor = Math.max(0.4, 1 + stageDiff * 0.3);

      const basePower = Math.max(1, stats.power * stageFactor);
      const basePhys  = Math.max(1, stats.physique * stageFactor);
      const baseRoot  = Math.max(1, stats.root * stageFactor);
      const baseAgi   = Math.max(1, stats.agility * stageFactor);

      function randAround(v) {
        const factor = 1 + (Math.random() * 2 - 1) * 0.25;
        return Math.max(1, Math.round(v * factor));
      }

      const ePower = randAround(basePower);
      const ePhys  = randAround(basePhys);
      const eRoot  = randAround(baseRoot);
      const eAgi   = randAround(baseAgi);

      const maxHp = 80 + ePhys * 9 + eRoot * 6;
      const atk   = 9 + ePower * 2;
      let dodge   = 0.04 + eAgi * 0.005;
      if (dodge > 0.35) dodge = 0.35;
      const spd   = 100 + eAgi * 2;

      const realmName = getRealmNameFromStage(enemyStage);
      const namePool = ['æ¸¸è¡ä¿®å£«', 'è¯•ç‚¼å¹»å½±', 'æµæµªæ•£ä¿®', 'åŒé—¨å‰‘ä¿®', 'å¤é˜µæ®‹å½±'];
      const n = namePool[Math.floor(Math.random() * namePool.length)];

      return {
        name: `${realmName}Â·${n}`,
        maxHp: Math.floor(maxHp),
        hp: Math.floor(maxHp),
        atk: Math.floor(atk),
        dodge,
        spd,
        physique: ePhys,
        root: eRoot
      };
    }

    /* ========== é‡ç½®ï¼ˆåªæ¸…ç©ºå½“å‰æ§½ä½ï¼‰ ========== */

    function resetGame() {
      gameStarted = false;
      currentPage = 'cultivation';
      autoBattle = false;

      qi = 0;
      qiPerSecond = 0.1;
      qiPerClick = 1.0;
      realmStage = 0;

      baseQiPerSecond = 0.1;
      baseQiPerClick = 1.0;
      realmQpsBonus = 0;

      stats = { ...baseStats };
      abilityPoints = 0;
      spiritStones = 0;
      experience = 0;

      caveCount = 0;
      caveQuality = 1;
      pillLevel = 1;
      pillQuality = 1;

      playerName = '';
      lingRoots = [];

      tempLingRoots = [];
      rootRollUsed = false;
      rootRerollLeft = 2;
      rootWheelRunning = false;
      if (rootWheelTimer) {
        clearInterval(rootWheelTimer);
        rootWheelTimer = null;
      }

      godTitleUnlocked = false;
      immortalTitle = '';
      immortalTitleUnlocked = false;

      currentBattle = null;
      if (battleTimerId) {
        clearTimeout(battleTimerId);
        battleTimerId = null;
      }
      currentMapId = 'map_0';

      learnedSkillIds = [];
      equippedMethodId = null;

      recalcDerivedStats();
    }

    /* ========== Root æŠ½å¡ UI é€»è¾‘ ========== */

    function resetRootDrawStateForNewGame() {
      tempLingRoots = [];
      rootRollUsed = false;
      rootRerollLeft = 2;
      rootWheelRunning = false;
      if (rootWheelTimer) {
        clearInterval(rootWheelTimer);
        rootWheelTimer = null;
      }
      rootWheelName.textContent = 'ç‚¹å‡»å¼€å§‹è½¬ç›˜';
      ROOT_COLOR_CLASS_LIST.forEach(c => rootWheelName.classList.remove(c));

      rootResultNameSpan.textContent = 'æœªæŠ½å–';
      rootResultTierSpan.textContent = '-';
      rootResultDescDiv.textContent = 'è¯·å…ˆç‚¹å‡»ã€Œå¼€å§‹æŠ½å–ã€ã€‚';
      rootRerollLeftSpan.textContent = rootRerollLeft;
      btnRootRoll.disabled = false;
      btnRootReroll.disabled = true;
      btnRootConfirm.disabled = true;
    }

    function renderRootPreview(roots) {
      if (!roots || roots.length === 0) {
        rootResultNameSpan.textContent = 'æœªæŠ½å–';
        rootResultTierSpan.textContent = '-';
        rootResultDescDiv.textContent = 'è¯·å…ˆç‚¹å‡»ã€Œå¼€å§‹æŠ½å–ã€ã€‚';
        ROOT_COLOR_CLASS_LIST.forEach(c => rootResultNameSpan.classList.remove(c));
        return;
      }
      const displayName = getLingRootDisplayNameFrom(roots);
      rootResultNameSpan.textContent = displayName;
      applyLingRootColor(rootResultNameSpan, roots);

      let tierText = '';
      const hasSpecial = roots.some(r => r.type === 'special');
      if (hasSpecial) {
        const order = ['T1', 'T2', 'T3', 'T4'];
        let bestTier = 'T4';
        let bestIndex = order.length;
        roots.forEach(r => {
          if (r.type === 'special') {
            const idx = order.indexOf(r.tierGroup);
            if (idx !== -1 && idx < bestIndex) {
              bestIndex = idx;
              bestTier = r.tierGroup;
            }
          }
        });
        tierText = bestTier + ' ç¨€æœ‰çµæ ¹';
      } else if (roots.length === 2) {
        const rel = getDualBasicRelation(roots);
        tierText = rel.label;
      } else {
        tierText = 'T5 å•äº”è¡Œçµæ ¹';
      }
      rootResultTierSpan.textContent = tierText;

      let desc = '';
      if (roots.length === 1) {
        const cfg = LING_ROOTS_CONFIG[roots[0].id];
        desc = cfg ? cfg.foundationRole + 'ã€‚' + (cfg.battle || '') : roots[0].desc;
      } else {
        const rel = getDualBasicRelation(roots);
        desc = rel.descExtra || 'ä¸¤ç§äº”è¡Œå¹¶å­˜ï¼Œéœ€è°¨æ…è°ƒå’Œã€‚';
      }
      rootResultDescDiv.textContent = desc;
    }

    function startRootWheelRoll() {
      if (rootWheelRunning) return;
      rootWheelRunning = true;
      btnRootRoll.disabled = true;
      btnRootReroll.disabled = true;
      btnRootConfirm.disabled = true;

      const candidates = LING_ROOTS;
      let idx = 0;
      rootWheelTimer = setInterval(() => {
        const r = candidates[idx % candidates.length];
        rootWheelName.textContent = r.name;
        applyLingRootColor(rootWheelName, [r]);
        idx++;
      }, 80);

      setTimeout(() => {
        if (rootWheelTimer) {
          clearInterval(rootWheelTimer);
          rootWheelTimer = null;
        }
        rootWheelRunning = false;

        const newRoots = generateLingRoots();
        tempLingRoots = newRoots;
        renderRootPreview(newRoots);

        btnRootConfirm.disabled = false;
        if (!rootRollUsed) {
          rootRollUsed = true;
          if (rootRerollLeft > 0) {
            btnRootReroll.disabled = false;
          }
        } else {
          if (rootRerollLeft > 0) {
            btnRootReroll.disabled = false;
          }
        }
      }, 1400);
    }

    /* ========== UI æ€»æ›´æ–° ========= */

    function updateUI() {
      qiSpan.textContent = qi.toFixed(1);
      qpsSpan.textContent = qiPerSecond.toFixed(2);
      qpcSpan.textContent = qiPerClick.toFixed(1);
      realmSpan.textContent = getRealmNameFromStage(realmStage);

      expMainSpan.textContent = experience.toFixed(0);
      if (isBigRoundStage(realmStage)) {
        const expReq = getCurrentExpRequirementForBreak(realmStage, experience);
        expReqSpan.textContent = expReq.toString();
        breakthroughBtn.disabled = !canManualBreakthrough();
      } else {
        expReqSpan.textContent = 'â€”';
        breakthroughBtn.disabled = true;
      }

      statPowerSpan.textContent = stats.power;
      statPhysiqueSpan.textContent = stats.physique;
      statAgilitySpan.textContent = stats.agility;
      statSpiritSpan.textContent = stats.spirit;
      statRootSpan.textContent = stats.root;
      statLuckSpan.textContent = stats.luck;

      abilityPointsSpan.textContent = abilityPoints;
      spiritStonesSpan.textContent = spiritStones;
      shopSpiritStonesSpan.textContent = spiritStones;
      experienceSpan.textContent = experience.toFixed(0);

      const buffMul = 1 + Math.min(experience * 0.002, 0.5);
      const buffPercent = Math.round((buffMul - 1) * 100);
      experienceBuffSpan.textContent = buffPercent;

      plusButtons.forEach(btn => {
        btn.disabled = abilityPoints <= 0;
      });

      let displayName = playerName || 'æœªå‘½å';
      if (godTitleUnlocked) displayName = 'ç¥Â·' + displayName;
      if (immortalTitleUnlocked && immortalTitle) displayName = immortalTitle + 'Â·' + displayName;
      playerNameSpan.textContent = displayName;

      caveCostSpan.textContent = getCaveBuyCost();
      caveCountSpan.textContent = caveCount;
      caveQualitySpan.textContent = getCaveQualityName();
      caveUpgradeCostSpan.textContent = (caveQuality >= MAX_CAVE_QUALITY ? 'å·²æ»¡çº§' : getCaveUpgradeCost());
      const caveQps = getCaveQps();
      caveQpsSpan.textContent = caveQps.toFixed(2);

      buyCaveBtn.disabled = spiritStones < getCaveBuyCost();
      upgradeCaveBtn.disabled = caveQuality >= MAX_CAVE_QUALITY || spiritStones < getCaveUpgradeCost();

      pillCostSpan.textContent = getPillBuyCost();
      pillLevelSpan.textContent = pillLevel;
      pillQualitySpan.textContent = getPillQualityName();
      pillUpgradeCostSpan.textContent = (pillQuality >= MAX_PILL_QUALITY ? 'å·²æ»¡çº§' : getPillUpgradeCost());

      buyPillBtn.disabled = spiritStones < getPillBuyCost();
      upgradePillBtn.disabled = pillQuality >= MAX_PILL_QUALITY || spiritStones < getPillUpgradeCost();

      if (buyWashRootPillBtn) {
        buyWashRootPillBtn.disabled = !gameStarted || !lingRoots.length || spiritStones < washPillCost;
      }

      updateBattleStatsUI();
      autoBattleToggle.checked = autoBattle;
      updateLingRootUI();
      updateSkillsUI();
      refreshSectOfferingsUI();
      refreshShopSkillsUI();
      updateSaveSlotUI();
    }

    /* ========== é¡µé¢åˆ‡æ¢ ========= */

    function switchPage(page) {
      currentPage = page;
      pageCultivation.style.display = (page === 'cultivation') ? 'block' : 'none';
      pageBattle.style.display      = (page === 'battle') ? 'block' : 'none';
      pageShop.style.display        = (page === 'shop') ? 'block' : 'none';
      pageSkills.style.display      = (page === 'skills') ? 'block' : 'none';
      pageSect.style.display        = (page === 'sect') ? 'block' : 'none';

      navItems.forEach(item => {
        const p = item.getAttribute('data-page');
        if (p === page) item.classList.add('active');
        else item.classList.remove('active');
      });
    }

    /* ========== æˆ˜æ–—æµç¨‹ ========= */

    function startNewBattle() {
      const map = getCurrentMap();
      const baseStatsBattle = getPlayerBattleStats();
      const eff = getLingRootBattleEffects();
      const player = {
        ...baseStatsBattle,
        hp: baseStatsBattle.maxHp,
        mp: baseStatsBattle.mpMax,
        eff,
        usedDimSlash: false
      };
      const enemy = generateRandomEnemy(map.enemyStage);

      currentBattle = {
        map,
        player,
        enemy,
        turn: 1
      };
      battleResultDiv.textContent = '';
      battleLogDiv.innerHTML = '';
      runBattleTurn();
    }

    function appendBattleLog(text) {
      const line = document.createElement('div');
      line.textContent = text;
      battleLogDiv.appendChild(line);
      battleLogDiv.scrollTop = battleLogDiv.scrollHeight;
    }

    function finishBattle() {
      if (!currentBattle) return;
      const { map, player, enemy } = currentBattle;
      battleTimerId = null;

      let resultText = '';
      let rewardQi = 0, rewardExp = 0, rewardStones = 0;
      const mapMult = map.rewardMult || 1;
      const expBuffMul = 1 + Math.min(experience * 0.002, 0.5);

      if (player.hp <= 0 && enemy.hp <= 0) {
        resultText = 'æ¿€æˆ˜è¿‡åï¼Œä½ ä¸æ•ŒäººåŒåŒåŠ›ç«­å€’ä¸‹ï¼Œè¿™ä¸€å±€ç®—ä½œå¹³å±€ã€‚';
        rewardQi = Math.floor(3 * mapMult);
        rewardExp = Math.floor(1 * mapMult);
        rewardStones = Math.floor(1 * mapMult);
      } else if (enemy.hp <= 0) {
        resultText = 'ä½ æˆ˜èƒœäº†æ•Œäººï¼Œå¸¦ç€æ»¡èº«ä¼¤ç—•ç¦»å¼€æˆ˜åœºã€‚';
        rewardQi = Math.floor(10 * mapMult * expBuffMul);
        rewardExp = Math.floor(4 * mapMult);
        rewardStones = Math.floor(5 * mapMult);
      } else if (player.hp <= 0) {
        resultText = 'ä½ è´¥ä¸‹é˜µæ¥ï¼Œåªå¾—æ’¤é€€ç–—ä¼¤ã€‚';
        rewardQi = Math.floor(4 * mapMult);
        rewardExp = Math.floor(2 * mapMult);
        rewardStones = Math.floor(2 * mapMult);
      } else {
        resultText = 'ä½ ä¸æ•Œäººç¼ æ–—è®¸ä¹…ï¼ŒåŒæ–¹éƒ½æœªèƒ½å å¾—ä¸Šé£ï¼Œåªå¾—æš‚æ—¶ç½¢æˆ˜ã€‚';
        rewardQi = Math.floor(6 * mapMult);
        rewardExp = Math.floor(3 * mapMult);
        rewardStones = Math.floor(3 * mapMult);
      }

      qi += rewardQi;
      experience += rewardExp;
      spiritStones += rewardStones;
      rollAbilityPoint('battle');
      checkBreakthrough();
      recalcDerivedStats();
      updateUI();
      saveGame();

      const dropsText = `è·å¾—ï¼šçœŸæ°” +${rewardQi} Â· å†ç»ƒ +${rewardExp} Â· çµçŸ³ +${rewardStones}`;
      battleResultDiv.textContent = `${resultText} ${dropsText}`;
      appendBattleLog(resultText + ' ' + dropsText);
      randomEventDiv.textContent = getRandomEventText();
      resultSummary.textContent = resultText;
      resultDrops.textContent = dropsText;
      resultExtra.textContent = `å½“å‰å¢ƒç•Œï¼š${getRealmNameFromStage(realmStage)} Â· ç´¯ç§¯å†ç»ƒ ${experience.toFixed(0)}`;

      if (!autoBattle) {
        battleResultOverlay.style.display = 'flex';
      }

      if (autoBattle && gameStarted) {
        currentBattle = null;
        battleTimerId = setTimeout(() => {
          startNewBattle();
        }, 800);
      } else {
        currentBattle = null;
      }
    }

    function runBattleTurn() {
      if (!currentBattle) return;
      const { map, player, enemy } = currentBattle;
      const eff = player.eff;

      if (currentBattle.turn > MAX_TURNS || player.hp <= 0 || enemy.hp <= 0) {
        finishBattle();
        return;
      }

      appendBattleLog(`ç¬¬ ${currentBattle.turn} å›åˆï¼š`);

      const pSpeed = player.spd * eff.speedMul;
      const eSpeed = enemy.spd * eff.enemySpeedMul;
      const firstIsPlayer = pSpeed >= eSpeed;

      function actorAttack(actorIsPlayer) {
        const atkSource = actorIsPlayer ? player : enemy;
        const defTarget = actorIsPlayer ? enemy : player;
        if (defTarget.hp <= 0) return;

        let dodgeChance;
        if (actorIsPlayer) {
          dodgeChance = defTarget.dodge;
        } else {
          dodgeChance = Math.min(0.6, defTarget.dodge + eff.dodgeBonus);
        }

        if (Math.random() < dodgeChance) {
          if (actorIsPlayer) {
            appendBattleLog('å¯¹æ–¹èº«å½¢ä¸€æ™ƒï¼Œé¿å¼€äº†ä½ çš„æ”»å‡»ã€‚');
          } else {
            appendBattleLog('ä½ çµå·§ä¸€é—ªï¼Œèº²è¿‡æ•Œäººçš„æ”»å‡»ã€‚');
          }
          return;
        }

        let damage;
        let useDim = false;

        if (actorIsPlayer && eff.burstDimSlash && !player.usedDimSlash && Math.random() < 0.1) {
          useDim = true;
          player.usedDimSlash = true;
          damage = calcDamage(player.atk * 20, defTarget.physique, defTarget.root);
        } else {
          const atkVal = atkSource.atk * (actorIsPlayer ? eff.atkMul : 1);
          damage = calcDamage(atkVal, defTarget.physique, defTarget.root);
          if (actorIsPlayer && Math.random() < eff.critChance) {
            damage = Math.floor(damage * eff.critMul);
            appendBattleLog('ä½ çš„æ”»å‡»æš´å‡»äº†ï¼');
          }
        }

        defTarget.hp -= damage;
        if (defTarget.hp < 0) defTarget.hp = 0;

        if (actorIsPlayer) {
          if (useDim) {
            appendBattleLog(`ä½ æ–½å±•ã€Œæ¬¡å…ƒè£‚æ–©ã€ï¼Œå¯¹æ•Œäººé€ æˆäº† ${damage} ç‚¹æ¯ç­æ€§ä¼¤å®³ï¼`);
          } else {
            appendBattleLog(`ä½ å¯¹æ•Œäººé€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼ˆæ•Œæ–¹å‰©ä½™ ${defTarget.hp}ï¼‰ã€‚`);
          }
          if (eff.lifeSteal > 0 && damage > 0) {
            const heal = Math.floor(damage * eff.lifeSteal);
            player.hp = Math.min(player.maxHp, player.hp + heal);
            appendBattleLog(`ä½ ä»æ”»å‡»ä¸­æ±²å–äº† ${heal} ç‚¹ç”Ÿå‘½ã€‚`);
          }
        } else {
          appendBattleLog(`æ•Œäººå¯¹ä½ é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼ˆä½ çš„å‰©ä½™ç”Ÿå‘½ ${defTarget.hp}ï¼‰ã€‚`);
        }
      }

      if (firstIsPlayer) {
        actorAttack(true);
        if (enemy.hp > 0) actorAttack(false);
      } else {
        actorAttack(false);
        if (player.hp > 0) actorAttack(true);
      }

      if (player.hp > 0 && eff.regenPerTurn > 0) {
        const heal = Math.floor(player.maxHp * eff.regenPerTurn);
        if (heal > 0) {
          player.hp = Math.min(player.maxHp, player.hp + heal);
          appendBattleLog(`ä½ çš„åŠŸæ³•åœ¨å›åˆç»“æŸæ—¶æ¢å¤äº† ${heal} ç‚¹ç”Ÿå‘½ã€‚`);
        }
      }

      currentBattle.turn++;
      battleTimerId = setTimeout(runBattleTurn, BATTLE_TURN_DELAY);
    }

    /* ========== è‡ªåŠ¨ä¿®ç‚¼ Tick ========= */

    function gameTick() {
      if (!gameStarted) return;
      qi += qiPerSecond;
      rollAbilityPoint('auto');
      if (Math.random() < 0.02) {
        spiritStones += 1; // æŒ‚æœºå°‘é‡çµçŸ³
      }
      checkBreakthrough();
      updateUI();
    }

    /* ========== åˆå§‹åŒ– ========= */

    function initGame() {
      generateMaps();
      loadGameAtStartup();
      initMaps();

      if (gameStarted) {
        startScreen.style.display = 'none';
        rootDrawPanel.style.display = 'none';
      } else {
        startScreen.style.display = 'flex';
        rootDrawPanel.style.display = 'none';
      }

      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const page = item.getAttribute('data-page');
          switchPage(page);
        });
      });
      switchPage(currentPage);

      cultivateBtn.addEventListener('click', () => {
        qi += qiPerClick;
        rollAbilityPoint('click');
        checkBreakthrough();
        updateUI();
      });

      plusButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const statKey = btn.getAttribute('data-stat');
          if (!statKey) return;
          if (abilityPoints <= 0) {
            alert('æ²¡æœ‰å¯åˆ†é…çš„èƒ½åŠ›ç‚¹ã€‚');
            return;
          }
          abilityPoints--;
          stats[statKey] = (stats[statKey] || 0) + 1;
          updateUI();
        });
      });

      saveBtn.addEventListener('click', () => {
        saveGame();
        alert('å·²æ‰‹åŠ¨ä¿å­˜å½“å‰ä¿®ç‚¼è¿›åº¦ã€‚');
      });

      resetBtn.addEventListener('click', () => {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ä¿®ç‚¼è¿›åº¦å¹¶é‡æ–°å¼€å§‹å—ï¼Ÿ\nå½“å‰æ§½ä½å­˜æ¡£ä¹Ÿä¼šè¢«è¦†ç›–ã€‚')) return;
        resetGame();
        saveGame();
        startScreen.style.display = 'flex';
        rootDrawPanel.style.display = 'none';
        updateUI();
      });

      breakthroughBtn.addEventListener('click', () => {
        doManualBreakthrough();
      });

      startGameBtn.addEventListener('click', () => {
        const name = playerNameInput.value.trim() || 'æ— åæ•£ä¿®';
        playerName = name;
        rootPlayerNameSpan.textContent = name;
        playerNameSpan.textContent = name;
        resetRootDrawStateForNewGame();
        startScreen.style.display = 'none';
        rootDrawPanel.style.display = 'block';
        updateUI();
      });

      btnRootRoll.addEventListener('click', () => {
        if (rootRollUsed) {
          alert('å·²å®Œæˆé¦–æ¬¡æŠ½å–ï¼Œè¯·ä½¿ç”¨ã€Œåˆ·æ–°çµæ ¹ã€ç»§ç»­é‡æŠ½ã€‚');
          return;
        }
        startRootWheelRoll();
      });

      btnRootReroll.addEventListener('click', () => {
        if (rootRerollLeft <= 0) {
          alert('å·²æ²¡æœ‰å‰©ä½™åˆ·æ–°æ¬¡æ•°ã€‚');
          return;
        }
        rootRerollLeft--;
        rootRerollLeftSpan.textContent = rootRerollLeft;
        startRootWheelRoll();
      });

      btnRootConfirm.addEventListener('click', () => {
        if (!tempLingRoots || !tempLingRoots.length) {
          alert('è¯·å…ˆæŠ½å–çµæ ¹ã€‚');
          return;
        }
        lingRoots = tempLingRoots;
        tempLingRoots = [];
        updateLingRootUI();
        recalcDerivedStats();
        gameStarted = true;
        rootDrawPanel.style.display = 'none';
        updateUI();
        saveGame();
      });

      buyCaveBtn.addEventListener('click', () => {
        const cost = getCaveBuyCost();
        if (spiritStones < cost) {
          alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æ´åºœã€‚');
          return;
        }
        spiritStones -= cost;
        caveCount++;
        recalcDerivedStats();
        updateUI();
        saveGame();
      });

      upgradeCaveBtn.addEventListener('click', () => {
        if (caveQuality >= MAX_CAVE_QUALITY) {
          alert('æ´åºœå“è´¨å·²è¾¾ä¸Šé™ã€‚');
          return;
        }
        const cost = getCaveUpgradeCost();
        if (spiritStones < cost) {
          alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•å‡çº§æ´åºœå“è´¨ã€‚');
          return;
        }
        spiritStones -= cost;
        caveQuality++;
        recalcDerivedStats();
        updateUI();
        saveGame();
      });

      buyPillBtn.addEventListener('click', () => {
        const cost = getPillBuyCost();
        if (spiritStones < cost) {
          alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ä¸¹è¯ã€‚');
          return;
        }
        spiritStones -= cost;
        pillLevel++;
        recalcDerivedStats();
        updateUI();
        saveGame();
      });

      upgradePillBtn.addEventListener('click', () => {
        if (pillQuality >= MAX_PILL_QUALITY) {
          alert('ä¸¹è¯å“è´¨å·²è¾¾ä¸Šé™ã€‚');
          return;
        }
        const cost = getPillUpgradeCost();
        if (spiritStones < cost) {
          alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•å‡çº§ä¸¹è¯å“è´¨ã€‚');
          return;
        }
        spiritStones -= cost;
        pillQuality++;
        recalcDerivedStats();
        updateUI();
        saveGame();
      });

      // â˜… æ´—é«“ä¸¹é€»è¾‘ï¼šæ‰£ 200 çµçŸ³ï¼Œç›´æ¥é‡æ–°æŠ½çµæ ¹
      if (buyWashRootPillBtn) {
        buyWashRootPillBtn.addEventListener('click', () => {
          if (!gameStarted) {
            alert('è¯·å…ˆå®Œæˆå¼€å±€å¹¶è§‰é†’çµæ ¹ã€‚');
            return;
          }
          if (!lingRoots || !lingRoots.length) {
            alert('ä½ ç›®å‰å°šæœªè§‰é†’çµæ ¹ï¼Œæ— éœ€æ´—é«“ã€‚');
            return;
          }
          if (spiritStones < washPillCost) {
            alert('çµçŸ³ä¸è¶³ï¼Œæ— æ³•è´­ä¹°æ´—é«“ä¸¹ã€‚');
            return;
          }
          if (!confirm('ç¡®å®šèŠ±è´¹ 200 çµçŸ³æœç”¨ã€Œæ´—é«“ä¸¹ã€ï¼Œé‡æ–°æŠ½å–ä¸€æ¬¡çµæ ¹å—ï¼Ÿ\nå½“å‰çµæ ¹å°†è¢«æ´—å»ï¼Œå¹¶éšæœºå‡èšå‡ºä¸€ç»„å…¨æ–°çš„çµæ ¹ã€‚')) {
            return;
          }
          spiritStones -= washPillCost;
          const oldName = getLingRootDisplayNameFrom(lingRoots);
          const newRoots = generateLingRoots();
          lingRoots = newRoots;
          const newName = getLingRootDisplayNameFrom(lingRoots);
          recalcDerivedStats();
          updateUI();
          saveGame();
          alert(`ä½ æœä¸‹æ´—é«“ä¸¹ï¼Œä½“å†…çµæ ¹å‰§å˜ï¼\nåŸçµæ ¹ã€${oldName}ã€‘è¢«æ´—å»ï¼Œé‡æ–°å‡èšä¸ºã€${newName}ã€‘ã€‚`);
        });
      }

      mapSelect.addEventListener('change', () => {
        currentMapId = mapSelect.value;
        saveGame();
      });

      autoBattleToggle.addEventListener('change', () => {
        autoBattle = autoBattleToggle.checked;
        if (!autoBattle && battleTimerId) {
          clearTimeout(battleTimerId);
          battleTimerId = null;
        }
        saveGame();
      });

      startBattleBtn.addEventListener('click', () => {
        if (!gameStarted) {
          alert('è¯·å…ˆå®Œæˆå¼€å±€å¹¶è§‰é†’çµæ ¹ã€‚');
          return;
        }
        if (battleTimerId) {
          alert('æ¸¸å†æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™ã€‚');
          return;
        }
        startNewBattle();
      });

      closeResultBtn.addEventListener('click', () => {
        battleResultOverlay.style.display = 'none';
      });

      recalcDerivedStats();
      updateUI();

      setInterval(gameTick, 1000);
    }

    window.addEventListener('load', initGame);
  </script>
</body>
</html>
